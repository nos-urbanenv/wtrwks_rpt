---
title: "浄水処理実験 実験レポート"
header: "都市工学演習B2 + 環境工学実験演習第二"
author: "03250114 大隅伸明"
subtitle: "実験実施期間：2025年12月9日~2025年12月26日"
bibliography: "references.bib"
echo: false
format: 
  html:
    toc: true
  #pdf:
   # pdf-engine: lualatex
    #documentclass: ltjsreport
    #fig-pos: 'h'
    #tbl-pos: 'h'
    #classoption: [10pt]
editor: visual
---

```{r setup}
#| include: false
library(tidyverse)
library(gt)
library(gridExtra)
library(ggpmisc)

hiragino <- "Hiragino Maru Gothic Pro"

# readxl packageの公式ドキュメントでは、EXCELファイルのミラーイメージをcsvとして保存することが推奨されている。
# ./data_rawディレクトリにあるxlsxなどの形式の入力ファイルを、使用目的ごとにcsvに分割してミラーとし、githubでの更新履歴追跡を容易にする。
# readxlのドキュメントで推奨されているそのままのコード。
cur_dir <- getwd()
rawdata_dir <- paste0(cur_dir, "/data_raw") #元データ格納先
output_dir <- paste0(cur_dir, "/data") #データ出力先
xlsx_path <- paste0(rawdata_dir, "/input.xlsx") #excelのパス

read_then_csv <- function(sheet, path, opt_dir){
  sheet_dat <- readxl::read_xlsx(sheet = sheet, path = path)
  csv_path <- paste0(opt_dir ,"/" ,sheet,".csv")
  write.csv(sheet_dat, file = csv_path, row.names = FALSE)
}

# 実験ノートから手入力したデータ
readxl::excel_sheets(xlsx_path) %>% 
  map(read_then_csv, path = xlsx_path, opt_dir = output_dir) 

# 機器分析の結果 絶対にいじらない。
# 今回はTOCのみ(※belsorpはbashで別に処理)
list.files(rawdata_dir, pattern = "TOC*", full.names = TRUE) %>% 
  set_names() %>%  #よくわからないがチュートリアルに従って入れた。
  map(~readxl::read_xlsx(.x)) %>% 
  imap(function(x, idx)
       write.csv(x, file=paste0(
         output_dir, "/",
         tools::file_path_sans_ext(basename(idx)),
         ".csv"),
         row.names = FALSE
         ))

# 検量線の濃度推定に使う関数
inverse_pred.calc <- function(y, alpha, beta){
  return((y - beta) / alpha)
}

inverse_pred <- function(y, lm_mod){
  alpha <- unname(lm_mod$coefficients[2])
  beta <- unname(lm_mod$coefficients[1])
  
  blank_y <- min(lm_mod$model[[1]])
  lower_lim <- inverse_pred.calc(y = min(lm_mod$model[[1]]),
                                  alpha = alpha,
                                  beta = beta)
  upper_lim <- inverse_pred.calc(y = max(lm_mod$model[[1]]),
                                  alpha = alpha,
                                  beta = beta)
  pred.val <- inverse_pred.calc(y = y,
                                alpha = alpha,
                                beta = beta)
  if(is.na(y)){
    return(tibble(MB_conc=NA, MB_info=NA))
  }
  #else if(pred.val < lower_lim){
  else if(y < blank_y){
    return(tibble(MB_conc=NA, MB_info="<LOD"))
  }
  else if(pred.val > upper_lim){
    return(tibble(MB_conc=pred.val, MB_info="外挿"))
  }
  else{
    return(tibble(MB_conc=pred.val, MB_info="fine"))
  }
}
```

# 本実験演習の目的

上水実験課題では以下の項目を扱い、浄水処理の物理化学的な原理について定性的・定量的な両面から理解を深めることを目的とする。

1.  凝集沈殿における最適条件の決定

2.  急速濾過における目詰まり状況の解析

3.  オゾンによる有機物分解

4.  活性炭の吸着特性の解析

5.  消毒

    1.  塩素消毒

    2.  紫外線消毒

# 課題A 凝集沈殿における最適条件の決定

## 実験概要

凝集沈殿法は水中の濁度や色度、リンを除去するプロセスで、浄水処理や排水処理において広く用いられている。自然水中の濁質は負電荷を帯びたコロイドとして存在する。そこで、凝集沈殿法ではアルミニウムイオンなどの正電荷を持った金属イオンを添加することで、負電荷を持つコロイド粒子の電荷を中和する。その結果、ファンデルワールス力による引力の方が静電斥力よりも大きくなることで粒子は凝析し、フロック（集塊）を形成する。その後緩速で撹拌することによりフロックどうしを凝集させることで、濾過により除去可能な大きさにまでフロックを成長させる。

凝集沈殿においては、凝集剤が水中で加水分解を起こす際に水中のアルカリ度が消費されるため、アルカリ度が運転管理上重要な指標となる。また、pHなどの原水水質によっても凝集プロセスの効果は大きく左右される。これらの複雑な要因が絡み合っており、凝集剤の最適な注入量を理論的に決定することは難しいとされる。そこで実務においては、実際のプラントを模したジャーテストを行うことで注入量の決定が行われる。

今回の実験演習では、三四郎池の水および、カオリンを分散させたコロイド溶液について、硫酸アルミニウムを凝集剤として用いてジャーテストを行い、凝集剤の最適注入量を決定する。三四郎池については、本実験で決定した最適注入量の値を用いて課題Bの急速濾過実験を行う。

## 結果

まず、二種類の水試料について、凝集剤の濃度を変化させて凝集剤の最適添加量を求めた。実験結果を @tbl-flc-amt に示す。

```{r calc-ttr_fctr}
# 滴定に用いた0.01M硫酸の濃度補正のためのファクター
ttr_amt <- 17.94 # 他班を取り込む場合はリストにするかも?
ttr_fctr <- 20 / ttr_amt 
```

なお、m-アルカリ度の測定に用いる0.01mol/L硫酸の標定を行った結果、ファクターは `r round(ttr_fctr,2)` となった。

```{r tbl-flc-amt}
#| tbl-cap: "凝集剤添加量の決定"

# データ読み込み
flc_amt <- read.csv("data/flc_amt.csv")

# m-アルカリ度計算
# pH4.8に達するまでに必要な酸の量をCaCO3の質量として求める(1Lあたり)
# 前期は滴定量が100mL指定だったが今期は可変なので注意。

# CaCO3当量(mg/L)に換算する
#モル質量100(以下では100.9)とした時に班EXCELとの一致を確認済み。
flc_amt <- flc_amt %>%
  filter(班==3) %>% 
  mutate(滴下量 = 滴定_前 - 滴定_後) %>% 
  mutate(mアルカリ度 = 
           # 硫酸の消費モル数：滴定量_ml / 1000 * 0.01(mol/L) * factor
           滴下量 / 1000 * 0.01 * ttr_fctr *
           # 100.09 * 1000を掛ければCaCO3当量(mg)が得られる
           100.09 * 1000 / 
           # 試料1LあたりのCaCO3当量を得るために、(試料量/1000)で割る
           (滴定試料量/1000)
         )

# 凝集剤投入量決定実験の表組み
flc_amt %>%
  filter(班==3) %>% 
  select(-c("班","滴定_前","滴定_後")) %>% 
  group_by(実験) %>% 
  gt() %>% 
  #アルカリ度は有効数字3桁。
  # カオリン75以外は小数点以下1桁でうまくいく。
  # カオリン75だけ別指定したいんだがやり方は不明。
  # 何なら有効数字の表記法として正式にどうすればよいのかわからん。。
  fmt_number(columns="mアルカリ度", decimals=1) %>% 
  cols_align(align = "center", columns = everything()) %>% 
  cols_move_to_end(columns = starts_with("滴")) %>%
  tab_spanner(label = "滴定生データ(mL)",
              columns = c("滴下量","滴定試料量")) %>%
  cols_label(凝集剤濃度="凝集剤(mg/L)",
             pH.後.="pH",
             ) %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

濁度の除去性能を比較した結果、最適な凝集剤濃度は三四郎池の場合は50mg/L、カオリン原水の場合は20mg/Lであるとわかった。

次に、上記で求めた最適量だけ凝集剤を添加した条件の下で、pHを酸性\~アルカリ性の数段階で変化させ、前後のpH変化ならびに、処理後の濁度・ゼータ電位・水温・m-アルカリ度を計測した結果を @tbl-flc-ph に示す。なお、pHがおおよそ5よりも小さい条件においてはm-アルカリ度の測定は行っていない。

```{r tbl-flc-ph}
#| tbl-cap: "各pH条件下での反応の比較"

#ttr_fctrは当然、凝集剤添加量決定時と同じものを使用する。
flc_ph <- read.csv("data/flc_ph.csv") %>% 
  filter(班==3) %>% 
  mutate(滴下量 = 滴定_前 - 滴定_後) %>% 
  mutate(mアルカリ度 = 
           滴下量 / 1000 * 0.01 * ttr_fctr *
           100.09 * 1000 /
           (滴定試料量/1000)
         )

# 添加量決定の際と同じ処理にしよう。
flc_ph %>% 
  mutate(滴定試料量=case_when(
    理論pH=="pH3"~NA,
    理論pH=="pH5"~NA,
    .default = 滴定試料量)) %>% 
  #filter(班==3) %>% 
  select(-c("班","滴定_前","滴定_後","理論pH","凝集剤添加量")) %>% 
  group_by(試料) %>% 
  gt() %>% 
  # pH11のところが有効数字がおかしいので個別で指定する必要あり。
  fmt_number(columns="mアルカリ度", decimals=1) %>% 
  cols_align(align = "center", columns = everything()) %>% 
  cols_move_to_end(columns = starts_with("滴")) %>%
  tab_spanner(label = "滴定生データ(mL)",
              columns = c("滴下量","滴定試料量")) %>% 
  #tab_header(title="各phでの反応の比較") %>% 
  cols_label(pH前="pH(前)",
             pH後="pH(後)",
             mアルカリ度="m-アルカリ度") %>% 
  tab_options(
    latex.use_longtable = TRUE
  ) %>% 
  sub_missing(missing_text = "-")
```

2種類の原水について、凝集剤注入量と上澄み液の濁度の関係を @fig-flc-turb に、凝集剤注入量と上澄み液のアルカリ度の関係を @fig-flc-alkarine に、原水のpHと上澄み液の濁度の関係を @fig-flc-ph にそれぞれ示した。凝集剤濃度については、最適注入量から注入量を増やした場合・減らした場合の両方について、濁度の除去効率が下がるということがわかる。また、凝集剤濃度が上がるほどアルカリ度が消費されていることもグラフから読み取れる。pHと濁度の関係については、カオリンに関してはpH8\~9付近で濁度が極小値となっている一方で、三四郎池では変化の傾向は一定しておらず、原水中に存在する様々な化学種が複雑な影響を与えていると推測される。

```{r fig-flc-turb, dev='jpeg'}
#| warning: false
#| fig-cap: "凝集剤注入量と上澄み液の濁度の関係"

flc_amt %>% 
  ggplot(aes(x=凝集剤濃度,y=濁度,color=実験))+
  geom_point(size=2)+
  labs(
    x="凝集剤濃度(mg/L)",
    y="上澄み液の濁度",
    color="原水"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

```{r fig-flc-alkarine, dev='jpeg'}
#| warning: false
#| fig-cap: "凝集剤注入量と上澄み液のアルカリ度の関係"

flc_amt %>% 
  ggplot(aes(x=凝集剤濃度,y=mアルカリ度,color=実験))+
  geom_point(size=2)+
  labs(
    x="凝集剤濃度(mg/L)",
    y="上澄み液のm-アルカリ度",
    color="原水"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

```{r calc-alkarine-real}
# アルカリ度の減少割合を予め計算しておく
flc_amt_mod <- flc_amt %>% 
  group_by(実験) %>% 
  nest() %>% 
  mutate(lm = map(data, function(df) lm(df$凝集剤濃度 ~ df$mアルカリ度))) 

# カオリンが先。今後index参照で間違えないように。
alkarine_dec_val <- flc_amt_mod %>%
  arrange(実験) %>% 
  mutate(alkarine_dec = map(lm,function(mod){
    format(unname(mod$coefficients[2]),digits=3)
                         })) %>% 
  mutate(alkarine_dec = as.numeric(alkarine_dec)) %>% 
  #select(c("実験","alkarine_dec"))
  pull(alkarine_dec)
```

```{r fig-flc-ph, dev='jpeg'}
#| warning: false
#| fig-cap: "原水のpHと上澄み液の濁度の関係"

flc_ph %>% 
  ggplot(aes(x=pH前,y=濁度,color=試料))+
  geom_point(size=2)+
  #geom_line(linetype=3,linewidth = 1.2)+
  labs(
    x="原水のpH",
    y="上澄み液の濁度",
    color="原水"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

## 考察

#### アルカリ度減少に関する定量的考察

凝集剤(硫酸アルミニウム)の添加によってアルカリ度が消費されるのは、 @eq-alkarine のような反応が起こっているからである。

$$
Al_2(SO_4)_3+3Ca(HCO_3)_2 \longrightarrow 2Al(OH_3)+6CO_2+3CaSO4 \downarrow 
$$ {#eq-alkarine}

```{r calc-alkaline_theory}
bando <- 342.15 # g/mol
caco3_alkarine <- 300

alkarine_theory <- caco3_alkarine / bando
```

硫酸アルミニウムの分子量は `r bando` (g/mol)で、炭酸水素カルシウム1mol/Lはアルカリ度換算で `r caco3_alkarine` g/Lと換算されるため、凝集剤濃度1mg/Lに対する理論上でのアルカリ度の減少量は `r round(alkarine_theory,2)` mg/Lと計算される。

実際の実験においては、 @tbl-flc-ph に示した通り、ほとんどの場合において凝集剤添加前と添加後でpHが下がっている。これは、硫酸アルミニウムによりアルカリ度が消費された結果、水素イオン濃度が上昇したことを意味すると考えられる。 その一方で、 @fig-flc-alkarine の各原水での近似直線の傾きを求めたところ、凝集剤1mg/Lあたりのm-アルカリ度の減少量をは、三四郎池においては `r alkarine_dec_val[[2]]*(-1)` mg/L、カオリン原水においては `r alkarine_dec_val[[1]]*(-1)` mg/Lとなり、理論量の2倍以上の値となった。

#### 凝集工程の自動化の難しさについて

先述したように、凝集沈殿プロセスにおいてはpH、アルカリ度などの様々な水質が複雑に絡み合っているため、一般的な水質指標から凝集剤の最適注入量を理論的に決定することが難しいことが、自動化の実現を妨げていると考えられる。機械学習などの技術により予測モデルを構築することができるかもしれないが、凝集沈殿の効率は化学的な要因に加え、撹拌強度や施設(急速撹拌池や沈澱池など)の構造といった物理的な要因によっても規定されるため、統一的な理論や予測モデルの実現はハードルが高いと考えられる。従って、現在のジャーテストによる注入量決定・運転管理は合理的なものであるといえる。

#### ALT比の算出

凝集剤注入量決定操作とpH最適条件決定操作それぞれにおけるALT比を @tbl-ALT-amt ならびに @tbl-ALT-ph に示す。凝集剤注入量決定においては、ALT比の定義通り、凝集剤を注入するほどALT比が上昇している。pH決定実験においては、0.98ならびに0.68と、通常の運転管理で採用されている値よりも数倍大きな値となってしまった。

この理由としては、今回処理した水の濁度が実際に浄水場で処理される水の濁度よりも低かったためであると考えられる。

```{r tbl-ALT-amt}
#| tbl-cap: "凝集剤注入量決定実験におけるALT比"

flc_amt %>% 
  select("実験","凝集剤濃度","濁度") %>% 
  mutate(原水濁度=case_when(実験=="三四郎"~8.083,
                   実験=="カオリン"~4.634)) %>% 
  mutate(ALT = 凝集剤濃度 * (27*2/342.15) / 原水濁度) %>% 
  group_by(実験) %>% 
  gt() %>% 
  cols_label(凝集剤濃度 = "凝集剤添加量(mg/L)",
             ALT = "ALT比") %>% 
  fmt_number(columns = "ALT", decimals = 2)
```

```{r tbl-ALT-ph}
#| tbl-cap: "pH最適条件決定実験におけるALT比"

flc_ph %>% 
  select("pH前","試料","濁度") %>% 
  mutate(凝集剤添加量 = case_when(
    試料 == "三四郎" ~ 50,
    試料 == "カオリン" ~ 20
  )) %>% 
  mutate(原水濁度=case_when(試料=="三四郎"~8.083,
                   試料=="カオリン"~4.634)) %>% 
  mutate(ALT = 凝集剤添加量 * (27*2/342.15) / 原水濁度) %>% 
  group_by(試料) %>% 
  gt() %>% 
  cols_label(凝集剤添加量 = "凝集剤添加量(mg/L)",
             ALT = "ALT比",
             pH前 = "原水pH") %>% 
  fmt_number(columns = "ALT", decimals = 2) %>% 
  cols_move(columns = "凝集剤添加量",after = "pH前")
```

#### G値の算出

水道施設設計指針によれば、フラッシュミキサ方式の混和池において撹拌翼の回転速度と抵抗係数をもとにする場合、G値は @eq-g-val によって算出される。

$$
G = \sqrt{\frac{\rho C a v^3}{2\mu V}}\\
ただし、\\
\rho : 水の密度(kg/m^3)\\
C : 撹拌翼の抵抗係数(=1.5)\\
a : 撹拌翼の運動方向に直角な面積(m^2)\\
v : 撹拌翼の平均速度(m/s)\\
\mu : 水の粘性係数(kg/m\cdot s)\\
V : 混和池の容量
$$ {#eq-g-val}

今回は水の密度は1000(kg/m\^3)、水の粘性係数は設計指針を参照し、1.0×10\^-3(kg/m\*s, 20°Ｃでの値)として計算した。 また、撹拌翼のサイズは5.8×1.9cmで、円筒形の部分の直径が2.2cmであった。ビーカー内の水量1Lを混和池の容量とした。

```{r calc-g-val}
rho <- 1000 # kg/m^3
C <- 1.5
a_gval <- (1.8/100)*(1.9/100) # m^3

v_gval_fast <- (120/60*2*pi) * (5.8/4/100) # m/s
v_gval_slow <- (30/60*2*pi) * (5.8/4/100)

mu_gval <- 0.001 # 粘性係数
vol_gval <- 0.001 # 1Lをm^3換算

g_val_fast <- sqrt((rho*C*a_gval*v_gval_fast^3) / (2*mu_gval*vol_gval))
g_val_slow <- sqrt((rho*C*a_gval*v_gval_slow^3) / (2*mu_gval*vol_gval))
```

緩速撹拌におけるG値は `r round(g_val_slow,1)` 、急速撹拌におけるG値は `r round(g_val_fast,1)` と算出された。ここから、緩速撹拌と急速撹拌では与えられるエネルギー量が10倍ほど違うことがわかる。

#### ゼータ電位とジャーテスト結果の比較考察

濁度とゼータ電位の関係を @fig-turb-z に示した。本来は、「ゼータ電位がゼロに近いほど凝集しやすい」（=負電荷を中和するのに必要な凝集剤が少なくて済むから）という関係が成り立つはずである。カオリン原水については、凝集最適pHの時以外であれば、ゼータ電位が0に近づくごとにゆるやかに濁度が低下している様子が観察できる一方で、三四郎池においては濁度が乱高下しているため、一定の関係性がみられない。この理由としては、三四郎池の原水には、様々な種類の懸濁物が含まれているため、ゼータ電位の測定結果が安定しなかったのではないかと推測される。

```{r fig-turb-z, dev='jpeg'}
#| warning: false
#| fig-cap: "濁度とゼータ電位の関係"

flc_ph %>% 
  ggplot(aes(x=ゼータ電位,y=濁度,color=試料))+
  geom_point()+
  labs(
    x="ゼータ電位",
    y="濁度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

# 課題B 急速濾過における目詰まり状況と処理性能の解析

## 実験概要

### 実験原理

急速濾過法はヨーロッパに比べて水需要が多い上、原水濁度が高いアメリカで発達したプロセスである。急速濾過池においては、硫酸アルミニウムなどを凝集剤としてフロックを形成させ、沈澱池で沈殿させた後、除去しきれなかった微細なフロックが、砂などの粒状濾材を用いて物理化学的に除去される。

本演習では、濾材に原水を通水して濁質を除去する「濾過」と、逆洗浄によって濁質を洗い流す「逆洗」という急速濾過法の2つのプロセスについてモデル実験を行う。原水としてカオリン懸濁液と三四郎池の水、濾材には砂・アンスラサイトを用い、濾過工程におけるろ過抵抗の測定を行う。ろ過抵抗は、濾過筒に接続されたマノメータにより深さごとの損失水頭を求めることで算出する。逆洗工程においては、濾材の下方から水道水を流し、様子を観察するとともに、逆洗水を一定時間ごとに採取してSS濃度を測定する。　また、濾材について、ふるい分けによる粒径決定、仮比重・真比重の測定を行う。

### 実験手順

実験手順の詳細を以下に示す。

#### 実験機器について

-   濾過筒の濾材構成

    -   A: 指定砂60cm

    -   B: 指定砂60cm

    -   C: アンスラサイト30cm(上部)⇨指定砂30cm(下部)

-   凝集剤：硫酸アルミニウム

#### 準備・凝集沈殿操作

1.  濾材の洗浄\
    水道水を用いて逆洗浄を行う。

2.  マノメータの点検\
    逆洗後、濾過筒に水を満たした状態でマノメータのバルブをすべて開く。水が流れていない状態では損失水頭は0なので、マノメータの高さは水平に揃うはずである。揃っていない場合は気泡が配管に残っている(=気泡による圧力水頭がマノメータの読みに影響を与えている)可能性があるため、マノメータ上部からゴム球で空気を送り込み、気泡を排除する。\
    その後、濾過筒下部の濾水流出バルブを開き、マノメータの水位が安定した後、マノメータの水位を記録する。この水位は「流出水位」に対応する。

3.  原水の作成・凝集沈殿操作\
    三四郎池の水を採取する。また、濃度が75mg/Lになるように水道水にカオリンを添加し、カオリン原水とする。前者には、実験Aで求めた最適凝集条件の通りに、後者には100mg/L凝集剤を投入し、2分程度、早めの回転数で急速撹拌する。その後、撹拌機の速度を弱め、緩速撹拌する。

4.  ポンプの流量調節\
    それぞれの濾過系統において用いるポンプの流量を、メスシリンダーを用いて流量を実測しながら、約650mL/minになるように調節する。調節後のポンプの流量を記録する。

#### 急速濾過・逆洗浄実験

1.  清水濾過実験\
    3系統それぞれの濾過筒について、水道水を通水し、単位ろ層厚さあたりの損失水頭を求める。

2.  急速濾過実験\
    まず、原水の濁度・温度を測定する。ポンプを稼働させて原水を通水し、15分間隔でマノメータの水位を記録する。また、30分間隔で原水・濾過水を採取し、濁度を測定する。マノメータの読みに注意し、目詰まりが起こるまで計測を継続する。

3.  逆洗浄実験(C筒のみ)\
    排水バルブ・マノメータバルブを閉じ、水道水により500L/hの流量で逆洗浄を用いる。また、逆洗浄開始時をt=0とし、適当な時間間隔ごとに逆洗排水を採取し、SSを測定する。逆洗終了時には、逆洗用バルブよりも、水道栓を先に閉めるように注意する。

## 結果と考察

### 急速濾過

マノメータ水位の変化を @tbl-manometer に示す。

```{r tbl-manometer}
#| tbl-cap: "マノメータ水位の変化"

# データ読み込み
manometer <- read.csv("data/manometer.csv") %>% 
  mutate(filter = paste0(filter,"筒")) %>% 
  pivot_longer(cols = c(starts_with("time_"), "tapwtr"),
                 names_to = "sampling")

# マノメータ水位データの表組み
manometer %>% 
  filter(!is.na(value)) %>% 
  pivot_wider(names_from = "manometer",
                values_from = "value") %>% 
  group_by(班, filter, sampling) %>% 
  filter(班==3) %>% 
  group_by(filter) %>% 
  gt() %>% 
  cols_hide("班") %>% 
  cols_label(sampling="") %>% 
  tab_spanner(columns = c(-"sampling"),
              label = "マノメータの読み(cm)") %>% 
  cols_move_to_start(columns = c(sampling)) %>% 
  sub_missing(missing_text = "欠測")
```

上記の実測値より、各マノメータごとの、それぞれの濾層(10cm刻み)あたりでの損失水頭を求めた結果を @tbl-lost-head に示す。なお、 @tbl-manometer に示した通り、マノメータの7番と8番は濾過プロセス全体を通してほぼ同一の値で水位している。これは、7番と8番のマノメータが濾過層よりも上部に設置されているためである。そこで、6番の損失水頭を求めるに当たっては、7番と8番のマノメータの読みの値の平均値から、6番のマノメータ水位を引くことによって求めた。

```{r tbl-lost-head}
#| tbl-cap: "マノメータごとの損失水頭"

# 損失水頭の計算
manometer_losthead <- manometer %>% 
  pivot_wider(names_from = "manometer",
              values_from = "value") %>% 
  mutate(no_loss = (`7` + `8`) / 2) %>% 
  filter(!is.na(no_loss)) %>% 
  select(-c("7","8")) %>% 
  mutate(
    loss_1 = `2` - `1`,
    loss_2 = `3` - `2`,
    loss_3 = `4` - `3`,
    loss_4 = `5` - `4`,
    loss_5 = `6` - `5`,
    loss_6 = no_loss - `6`
  ) %>% 
  select(-c("1","2","3","4","5","6")) %>% 
  rename_with(~ str_extract(.x, "\\d+"),
         starts_with("loss"))

# 損失水頭の表組み
manometer_losthead %>% 
  filter(班==3) %>% 
  select(-no_loss) %>% 
  group_by(filter) %>% 
  gt() %>% 
  cols_hide(columns = "班") %>% 
  tab_spanner(columns = c(-sampling),
              label = "濾過による損失水頭(cm)") %>% 
  cols_move_to_start(columns = c("sampling")) %>% 
  sub_missing(missing_text = "欠測")
```

@tbl-lost-head の値について、横軸に単位濾層あたりの損失水頭、縦軸に濾層深さをとってプロットした結果を @fig-manometer に示す。濾過砂のみのA筒・B筒では、濾層の上部で目詰まりが進行していることが確認でき、表面濾過の状態になっている。AとBを比較すると、目詰まりによる損失水頭の値がAの方が大きい。これは、Aで濾過されている三四郎池の水が、カオリン原水と比べて濁度が高いことに起因していると考えられる。また、筒Bにおいても、実験を数時間継続することで、A筒と同様、表面濾過による目詰まりにより、いずれ濾層が完全に閉塞を起こすことになると予想される。

上部にアンスラサイトを敷いたC筒では、上部での目詰まりが抑制され、中間部の指定砂の層で目詰まりが起こっている。中間部での損失水頭は、B筒に比べて半分程度に抑えられている。その一方で、後ほど示すように、B筒とC筒では濁度の除去率はどちらも90%を超えており、あまり違いはない。これは、上部のアンスラサイト層によって濁質が捕捉されていることを意味する。この結果から、上部に粗い濾材を配置し、フロックを侵入させて濾層内に濁質を捕捉するという、二層濾過の作用原理を確認することができる。

```{r fig-manometer, dev='jpeg'}
#| fig-cap: "マノメータの目詰まり状況"
#| warning: false

manometer_losthead %>% 
  filter(班==3) %>% 
  select(-no_loss) %>% 
  pivot_longer(cols=c("1","2","3","4","5","6"),
               values_to = "value",
               names_to = "manometer") %>% 
  # マノメータ番号を水位に変換
  mutate(manometer = as.numeric(manometer)) %>% 
  mutate(manometer = (7 - manometer) * 10) %>% 
  arrange(filter,sampling,manometer) %>% 
  # ggplotで描画
  ggplot(aes(x=value,y=manometer,color=sampling,group=sampling))+
  geom_point()+
  #geom_line(linetype=3)+
  geom_path(linetype=3)+
  scale_y_reverse()+
  facet_wrap(vars(filter),scales = "free")+
  labs(
    x="損失水頭(cm)",
    y="濾過層深さ(cm)"
  ) +
  theme_bw() +
  theme(text=element_text(family=hiragino))
```

次に、濁度の測定結果を @tbl-filt-turb に示す。また、濁度の除去率の経時変化を求め、 @fig-filt-turb に図示した。除去率の変化については、A筒とB筒にはあまり大きな違いは見られなかった。また、濾過砂のみを敷いたB筒よりも上部にアンスラサイトを敷いたC筒の方が全体を通じて除去率は数%ほど低く、除去率の低下も速かった。アンスラサイトを敷くことにより、全体としては損失水頭が小さくなり、目詰まりが抑制されるものの、濁度の除去効率は犠牲になってしまうということがわかる。

```{r tbl-filt-turb}
#| tbl-cap: "急速濾過実験における濁度の経時変化"

filt_turb <- read.csv("data/filt_turb.csv")
filt_turb <- filt_turb %>% 
  group_by(種類,試料,time) %>% 
  summarise(turb = mean(turb),
            .groups = "drop")

# 表組み
filt_turb %>% 
  mutate(time = paste0(time,"分")) %>% 
  pivot_wider(names_from = "time",
              values_from = "turb") %>% 
  gt() %>% 
  cols_merge(columns = c("種類","試料"),
             hide_columns = "試料",
             pattern = "{2} {1}") %>% 
  fmt_number(columns = everything(),
             decimals = 3) %>% 
  sub_missing(missing_text = "-")
```

```{r fig-filt-turb, dev='jpeg'}
#| fig-cap: "濁度の経時変化"
#| warning: false

filt_raw <- filt_turb %>% 
  filter(種類=="原水") %>% 
  rename(turb_raw = turb,
         試料_照合 = 試料)
filt_filtered <- filt_turb %>% 
  filter(種類=="濾過水") %>% 
  mutate(試料_照合 = case_when(
    試料=="A" ~ "三四郎",
    .default = "カオリン"
  )) %>% 
  rename(turb_filt = turb)

turb_filtered <- filt_filtered %>% 
  left_join(filt_raw,by=c("試料_照合","time")) %>% 
  select(c("試料","time",starts_with("turb"))) %>% 
  mutate(除去率 = (turb_raw - turb_filt) / turb_raw * 100)

turb_filtered %>% 
  ggplot(aes(x=time,y=除去率,color=試料)) +
  geom_point(size=3)+
  geom_line(linetype = 3, linewidth = 1.2)+
  labs(
    x="採水時刻(分)",
    y="除去率(%)"
  ) +
  theme_bw() +
  theme(text=element_text(family=hiragino))
```

### 逆洗浄

```{r calc-mass-balance}
# csv用意するのがめんどくさいので直接入力
reverse_SS <- tribble(
  ~time, ~bef_g, ~aft_g, ~amt_ml,
  28, 0.4036, 0.4116, 100,
  54, 0.4000, 0.4064, 100, 
  70, 0.4134, 0.4208, 100,
  82, 0.3999, 0.5724, 100,
  110, 0.4012, 0.4637, 100,
  139, 0.4069, 0.4402, 100,
  175, 0.4069, 0.4199, 100
) %>% 
  # SSの単位はmg/mL
  # 差(g)に1000掛けてmgに変換し、濾過量(公定法ではL)で割る
  mutate(SS = (aft_g - bef_g) * 1000 / (amt_ml / 1000))

# 面積(単位はmg*s/L)
graph_area <- reverse_SS %>% 
  select("time","SS") %>% 
  mutate(delta_x = time - lag(time),
         avg_SS = (SS + lag(SS)) / 2) %>% 
  summarise(area = sum(delta_x * avg_SS, na.rm = TRUE)) %>% 
  pull(area)

# 総量(L/sで表される流量を掛けて、単位はmgとなる。)
SS_all_real <- graph_area * (500 / 3600)

# 濾過側の計算(濾過体積に、フロック濃度175mg/Lを掛ける)
filt_vol <- 0.65 * 120
SS_all_estimated <- filt_vol * 175
```

逆洗時に採水を行い、SSを測定した結果を @tbl-reverse-SS に示す。また、SS濃度の経時変化を @fig-reverse-SS に図示した。逆洗時の流量は500L/h、つまり0.139L/sであった。グラフの面積を求め、流量を掛けると、濾層に捕捉されていた懸濁質の総量は `r format(SS_all_real,digits=4)` mgと求められる。 ところで、B筒・C筒で濾過を行ったカオリン原水には、カオリンが75mg/L、凝集剤が100mg/L添加されているため、フロックは1Lあたりにつき175mg含まれていると考えられる。濾過は約650mL/minの流量で120分間行ったので、濾過された原水の懸濁質の総量は `r format(SS_all_estimated,digits=5)` mgと計算される。

@fig-filt-turb に示したように、B筒の濁度除去率は常に98%以上で推移していたことを踏まえると、濁質量の実測値は理論値よりもやや少ない。この原因としては、逆洗時に流出した濁質量を台形の面積の総和であるグラフ面積によって近似しているため、面積を実際の捕捉量よりも小さく見積もってしまっていることが考えられる。また、逆洗によって完全に濁質が除去しきれていないとも考えられる。これらの点を踏まえれば、原水に含まれていた濁質の量と、濾層に捕捉されていた濁質の量はほぼ一致していると考えられ、濾過実験と逆洗浄実験の実験結果には整合性があったといえる。

```{r tbl-reverse-SS}
#| tbl-cap: "逆洗排水のSS濃度の経時変化"

reverse_SS %>% 
  gt() %>% 
  # 自班データに関しては整数表示で有効数字は問題なし。
  fmt_number(columns = "SS", decimals = 0) %>% 
  #見た目はなかなか悩ましい問題。
  cols_align(align = "center", columns = c(-"time")) %>% 
  cols_align(align = "left", columns = "time") %>% 
  cols_label(bef_g = "濾過前(g)",
             aft_g = "濾過後(g)",
             amt_ml = "濾過量(mL)",
             SS = "SS(mg/L)",
             time = "逆洗開始からの経過時間(s)")
```

```{r fig-reverse-SS, dev='jpeg'}
#| warning: false
#| tbl-cap: "逆洗排水のSS濃度の経時変化"

reverse_SS %>% 
  ggplot(aes(x=time,y=SS))+
  geom_point(size=3)+
  geom_area(position = "identity", fill=4)+
  geom_line(linetype = 1, linewidth = 2)+
  labs(
    x="逆洗開始からの経過時刻",
    y="SS濃度(mg/L)"
  ) +
  theme_bw() +
  theme(text=element_text(family=hiragino))
```

### ろ過筒の仕様測定

ふるい分けの結果を @tbl-sieve に示す。ふるい分けの結果をもとに作成した粒度加積曲線を @fig-sieve に示す。粒度加積曲線からは、指定砂の10%(有効径)、60%に相当する粒径は約0.6mmならびに約0.8mm、アンスラサイトに関しては約1.2mm/約1.6mmと読み取れる。従って、均等係数はそれぞれ `r format(0.8/0.6, digits=2)`、 `r format(1.6/1.2, digits=2)` と計算される。

```{r calc-sand}
msslndr <- 90.7132
msslndr_sand <- 162.2523
dens_aprnt <- (msslndr_sand - msslndr) / 50

wf_dens <- 27.1711
w_dens <- 113.8475
wb_dens <- 197.6861
wa_dens <- 144.2222
t_dens <- 22.0

dens_true <- (w_dens - wf_dens)/(w_dens - wf_dens + wa_dens - wb_dens)
```

また、指定濾過砂の仮比重は、メスシリンダーが `r msslndr` g、砂50mLを入れた際の重さが `r msslndr_sand` gとなったため、 `r format(dens_aprnt,digits=6)` g/mLと計算された。真比重については、ピクノメーター重量Wfが `r wf_dens` g、砂を入れたピクノメーターの重量Wが `r w_dens` g、砂以外をMilli-Qで満たした際の重量Wbが `r wb_dens` g、ピクノメーターを全量Milli-Qで満たした際の重量Waが `r wa_dens` gとなったため、真比重Gは `r format(dens_true,digits=6)` (g/mL)と計算された。

```{r tbl-sieve}
#| tbl-cap: "ふるい分けの結果"

filt_sand <- read.csv("data/filt_prtcl.csv")
filt_sand <- filt_sand %>% 
  group_by(濾材) %>% 
  mutate(抑留量 = weight - 皿の重さ,
         累積抑留量 = cumsum(抑留量),
         通過量 = sum(抑留量) - 累積抑留量,
         通過率 = 通過量 / max(通過量) * 100)

# ふるい分けの表組み
filt_sand %>% 
  select(-c("皿の重さ","weight","累積抑留量")) %>% 
  group_by(濾材) %>% 
  gt() %>% 
  fmt_number(columns = "通過率",decimals = 2) %>% 
  cols_label(目の開き_mm = "篩い目(mm)",
             抑留量 = "抑留量(g)",
             通過量 = "通過量(累加)(g)",
             通過率 = "通過率(%)")
```

```{r fig-sieve, dev='jpeg'}
#| fig-cap: "指定砂・アンスラサイトの粒度加積曲線"
#| warning: false

filt_sand %>% 
  ggplot(aes(x=目の開き_mm, y=通過率, color=濾材))+
  geom_point(size=3)+
  geom_line(linetype = 3, linewidth = 1.2)+
  geom_hline(yintercept = 60, color = "red")+
  geom_hline(yintercept =  10, color="blue")+
  scale_x_log10(minor_breaks = seq(0.1, 2, by = 0.1))+
  labs(
    x="粒径(mm)",
    y="通過率(%)"
  ) +
  theme_bw() +
  theme(text=element_text(family=hiragino))
```

### その他の考察課題

本章ではデータ解析と考察を同時に行ってきたが、これまで触れられていない考察課題について以下で述べる。

#### 濾過速度の算出

```{r calc-filt-speed}
kuugeki <- (dens_true - dens_aprnt) / dens_true * 100
no_sand_speed <- 650 * 60 * 24 / (6*6*pi) / 100
with_sand_speed <- no_sand_speed / (kuugeki / 100)
```

今回使用した指定濾過砂について、真比重は `r format(dens_true,digits=6)` g、仮比重は `r format(dens_aprnt,digits=6)` gと測定されたため、濾過筒の空隙率は `r format(kuugeki, digits=2)` %と計算される。

この空隙率をもとに、ろ過速度を計算する。まず、濾過筒に濾材が何も入っていないとした場合、650mL/minの流量は、 `r format(no_sand_speed,digits=2)` (m/day)と変換される。空隙率でこの数値を割り、ろ過速度は `r format(kuugeki,digits=2)` (m/day)と計算される。

#### 濁度指標の意義と問題点について

濁度は水道水質基準においてpH、味、色度、臭気とともに水の「基礎的性状」として位置付けられている。濁度が基礎的性状とされているのは、「濁り具合」という直観的な性質をよく反映した指標であるからだと考えられる。また、濁度は前処理がいらないため測定が容易である。学生実験で用いている積分球式光電光度法に加え、連続自動機器による透過散乱法などの自動測定方法も公定法に明記されており、実務の面でも使い勝手の良い指標であると考えられる。

しかしながら、濁度という物理的な性状のみを反映し、化学的な性質を反映できない指標だけに頼っていると、凝集剤によってフロックとして析出させることができない汚濁物質を見落とすことになる。例えば、水中で完全に溶解している糖類・アルコールなどの親水性有機物はフロックとして析出せず、濁度による水質管理では見落とされてしまう。また、水中でイオンとして存在している化学物質も、濁度による管理では検出が難しいと考えられる。消毒副生成物などの健康リスクに関わる有機物のリスクについても、濁度だけで評価を行うことは難しい。

以上のように、濁度は簡易的に水質の状態を把握する上では有用な指標ではあるものの、水道水質の品質管理においては濁度以外の指標を取り入れて管理が行われることが望ましいと考えられる。

# 課題C 活性炭による色度成分の吸着

## 実験概要

### 活性炭による色度成分吸着実験

活性炭とは、木質（ヤシ殻、おが屑や石炭など）を原料として、これらの原料を炭化および賦活処理によりつくられた多孔性の炭素質の物質であり、その大きな内部表面積や微小細孔により、水中の有機物等を吸着することができる。浄水処理においては、異臭味物質・農薬・微量有害物質・合成洗剤・色度成分・トリハロメタン前駆物質などの除去の目的で活性炭処理が行われている。

本実験演習では、色度成分としてメチレンブルーを溶解した溶液に、クラレコールGLC・クラレコールGWという二種類の活性炭を加えて回分実験を行う。一定時間毎に採水し、色度成分の濃度を測定することで、吸着速度について調べる。また、吸着が平衡に達した際の濃度データをプロットし、吸着等温式を適用することで、吸着等温線に関する理解を深める。

### 吸着等温線について

今回は活性炭による単成分の吸着現象について扱う。よく用いられる吸着等温線として、ラングミュア式とフロイントリッヒ式がある。今回はメチレンブルー吸着実験の平衡濃度の結果についてラングミュア・プロットならびにフロイントリッヒ・プロットを行うことで、吸着等温線の各定数を求め、実際の吸着平衡のグラフに重ね、モデルの妥当性について考える。

### ガス吸着による細孔分布解析

私はBELSORPにより出力される「生の吸着等温線データ」にも個人的に興味を持ったので、機器が接続されているPCから元データ格納先のファイルを探し、解析を行った。データ取得に際しては今野さんにご協力頂いた。解析に使用した元データファイルは、本レポートの巻末にリンクを示したgithubレポジトリ下、\~/data_rawディレクトリに格納されている。

## 結果

### 検量線の作成

まず、メチレンブルー濃度の推定用の検量線を作成した結果を示す。

複数の希釈列を作成し、665nm吸光度を測定し、全データで検量線を作成した結果を @tbl-abs-calib-1 ならびに @fig-abs-calib-1 に示す。 なお、私達3班は2日目の測定時に新しく検量線を作成していたが、4班は作成していなかったとのことなので、3種類の検量線データを記載した。また、この場合の各検量線の回帰式とR\^2値を @tbl-abs-models-1 に示した。

```{r tbl-abs-calib-1}
#| tbl-cap: "各希釈列ごとの吸光度"

# データ読み込み
abs_calib <- read.csv("data/abs_calib.csv")

# 検量線データの表組み
abs_calib %>% 
  pivot_wider(names_from = c(group, day),
              names_sep = "班_",
              values_from = ABS) %>% 
  gt() %>% 
  cols_label(MB_conc = "メチレンブルー濃度(mg/L)") %>% 
  tab_spanner(columns = c(-"MB_conc"),
              label = "665nm吸光度") %>% 
  sub_missing(missing_text = "-")
```

```{r fig-abs-calib-1, dev='jpeg'}
#| message: false
#| warning: false
#| fig-cap: "メチレンブルー濃度の検量線"

# 検量線可視化
abs_calib %>% 
  mutate(model = paste(group, "班-", day, "日目")) %>% 
  ggplot(aes(x=MB_conc, y=ABS)) +
  geom_point() +
  geom_smooth(method="lm",color="black")+
  labs(
    x="メチレンブルー濃度(mg/L)",
    y="665nm吸光度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  #stat_poly_eq(use_label(c("eq","R2")))+ #確認用。見にくいので非表示
  facet_wrap(vars(model))
```

```{r tbl-abs-models-1}
#| tbl-cap: "検量線の回帰式とR^2値"

# 検量線モデル作成
# 参考:tidyr::nest()の公式リファレンス
abs_models_all <- abs_calib %>% 
  group_by(group, day) %>% 
  nest() %>% 
  mutate(model = paste0(group, "班-", day, "日目"),
         lm = map(data, function(df) lm(ABS~MB_conc, data=df))) %>% 
  ungroup() %>% 
  select(-c("group", "day"))

# 検量線の式の表組み
abs_models_all %>% 
  ungroup() %>% 
  mutate(rgrsn = map_chr(lm, 
                     function(lm_mod){
                       alpha <- format(unname(lm_mod$coefficients[2]),
                                       digits=3)
                       beta <- format(unname(lm_mod$coefficients[1]),
                                      digits=3)
                       R2 <- format(summary(lm_mod)$r.squared,
                                    digits=4)
                       
                       return(paste0("y = ",alpha,"x + ",beta,
                                     ", R^2 = ",R2))
                     })) %>% 
  select(c("model", "rgrsn")) %>% 
  gt() %>% 
  cols_label(model="検量線",
             rgrsn="回帰式とR^2値")
```

@tbl-abs-models-1 に示した通り、R\^2値はどれも約0.99となっているものの、これはメチレンブルー濃度が20mg/Lの希釈列に引っ張られた結果であると考えられる。そのため、20mg/Lの希釈列を除いて再度検量線を作成した結果を @fig-abs-calib-2 、 @tbl-abs-models-2 に示す。 @fig-abs-calib-1 の検量線よりも正確に線形回帰できているため、この検量線を用いて濃度計算を行う。

```{r fig-abs-calib-2, dev='jpeg'}
#| message: false
#| warning: false
#| fig-cap: "メチレンブルー濃度の検量線(改良版)"

# 検量線可視化
abs_calib %>% 
  filter(MB_conc < 20) %>% 
  mutate(model = paste(group, "班-", day, "日目")) %>% 
  ggplot(aes(x=MB_conc, y=ABS)) +
  geom_point() +
  geom_smooth(method="lm",color="black")+
  labs(
    x="メチレンブルー濃度(mg/L)",
    y="665nm吸光度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  #stat_poly_eq(use_label(c("eq","R2")))+ #確認用。見にくいので非表示
  facet_wrap(vars(model))
```

```{r tbl-abs-models-2}
#| tbl-cap: "検量線の回帰式とR^2値(改良版)"

# 検量線モデル作成
abs_models <- abs_calib %>% 
  filter(MB_conc < 20) %>% 
  group_by(group, day) %>% 
  nest() %>% 
  mutate(model = paste0(group, "班-", day, "日目"),
         lm = map(data, function(df) lm(ABS~MB_conc, data=df))) %>% 
  ungroup() %>% 
  select(-c("group", "day","data"))

# 検量線の式の表組み
abs_models %>% 
  ungroup() %>% 
  mutate(rgrsn = map_chr(lm, 
                     function(lm_mod){
                       alpha <- format(unname(lm_mod$coefficients[2]),
                                       digits=3)
                       beta <- format(unname(lm_mod$coefficients[1]),
                                      digits=3)
                       R2 <- format(summary(lm_mod)$r.squared,
                                    digits=4)
                       
                       return(paste0("y = ",alpha,"x + ",beta,
                                     ", R^2 = ",R2))
                     })) %>% 
  select(c("model", "rgrsn")) %>% 
  gt() %>% 
  cols_label(model="検量線",
             rgrsn="回帰式とR^2値")
```

### メチレンブルー吸着実験

吸光度の経時変化を @tbl-abs-raw に示した。吸光度の値をもとに、先程作成した検量線を用いて濃度を計算した結果を @tbl-abs に示した。なお、4班のデータについては、十分に希釈を行っておらず、検量線が外挿となってしまった場合がある。その場合は数値の横に\*をつけて区別した。また、濃度の経時変化を @fig-abs に図示した。

```{r tbl-abs-raw}
#| tbl-cap: "665nm吸光度の経時変化"

# データ読み込み
abs <- read.csv("data/abs.csv")

# 表組み
abs %>% 
  select(-c("group",starts_with("Dil"))) %>% 
  group_by(crbn, MB_init_conc) %>% 
  rename_with(~ str_extract(.x, pattern="\\d+"), starts_with("ABS")) %>% 
  gt() %>% 
  cols_label(crbn_amt = "活性炭添加量(g)",
             `24` = "24時間後") %>% 
  sub_missing(missing_text = "-")
```

```{r calc-abs}
abs_calc <- abs %>% 
  as_tibble() %>% 
  pivot_longer(cols = c(starts_with("ABS_"), starts_with("Dil_")),
               names_to = c("abs_dat_type","time"),
               names_pattern = "(.*)_(.*)",
               values_to = "abs_dat_value")%>% 
  pivot_wider(names_from = abs_dat_type,
              values_from = abs_dat_value)

# 検量線モデルの適用
abs_calc <- abs_calc %>% 
  mutate(day = case_when(group=="3" & time=="24hrs" ~ 2,
                         .default = 1)) %>% 
  #group_by(group, day) %>% 
  #summarise(crbn=unique(crbn),
  #          MB_init_conc = list(MB_init_conc),
  #          crbn_amt = list(crbn_amt),
  #         time=list(time),
  #          ABS=list(ABS),
  #          Dil=list(Dil),
  #          .groups = "drop") %>% 
  mutate(model = paste0(group,"班-",day,"日目")) %>% 
  left_join(abs_models, by="model") %>% #検量線モデルと照合
  #mutate(res=map2(ABS,lm,function(list,mod){
  #  map_dfr(list,\(x) inverse_pred(x, mod))
  #})) %>%
  #select(-c("group","day","model","data","lm")) %>% 
  #unnest(-crbn) %>% 
  #ungroup()
  rowwise() %>% 
  mutate(res = inverse_pred(ABS, lm)) %>% 
  ungroup() %>% 
  unpack(res) %>% 
  select(-model, -lm, -group, -day) %>% 
  mutate(MB_conc = MB_conc * Dil) %>% 
  select(-ABS, -Dil)
```

```{r tbl-abs}
#| tbl-cap: "メチレンブルー濃度C(mg/L)の経時変化"

# 濃度の経時変化の表組み
abs_calc %>% 
  mutate(MB = case_when(
    MB_info == "fine" ~ as.character(round(MB_conc,0)),
    MB_info == "<LOD" ~ "検出限界",
    MB_info == "外挿" ~ paste0(round(MB_conc,0),"*"),
    .default = NA
  )) %>% 
  select(-MB_info,-MB_conc) %>% 
  pivot_wider(names_from = time,
              values_from = MB) %>%
  group_by(crbn, MB_init_conc) %>%
  gt() %>% 
  cols_label(crbn_amt="活性炭添加量(g)") %>% 
  tab_spanner(columns = c(ends_with("min"),"24hrs"),
              label = "メチレンブルー濃度C(mg/L)") %>% 
  sub_missing(missing_text = "-")
```

```{r fig-abs, dev='jpeg'}
#| fig-cap: "メチレンブルー濃度C(mg/L)の経時変化"
#| warning: false

abs_calc %>% 
  mutate(time = case_when(
    str_detect(time,"min$") ~ as.numeric(str_extract(time,"\\d+")),
    .default = 1440
  )) %>% 
  mutate(MB_conc = case_when( 
    MB_info == "<LOD" ~ 0, #検出限界は0としてプロット
    .default = MB_conc
  )) %>% 
  filter(!is.na(MB_conc)) %>% 
  ggplot(aes(x=time,y=MB_conc,group=crbn_amt,color=crbn_amt))+
  geom_point()+
  geom_line(linetype = 2)+
  scale_color_gradient(high = "red", low = "darkblue")+
  #scale_color_viridis_c(option = "viridis", direction = -1)+
  labs(
    x="経過時間(分)",
    y="メチレンブルー濃度(mg/L)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn, MB_init_conc))
```

次に、活性炭への吸着量をy軸にとったグラフを @fig-abs-2 に示す。

```{r fig-abs-2, dev='jpeg'}
#| fig-cap: "吸着量qeの経時変化"
#| warning: false

# 吸着量を求めるため一旦wideにしてmutateで処理する
getqe <- function(df){
  output <- df %>% 
  mutate(MB_q = case_when( 
    MB_info == "<LOD" ~ 0, #検出限界は0としてプロット
    .default = MB_conc
  )) %>% 
  select(-MB_info,-MB_conc) %>% 
  pivot_wider(names_from = time,
              values_from = MB_q) %>% 
  # 0分からの濃度減少量を引き算で求める
  mutate(across(c(ends_with("min"),"24hrs"),
         ~ `0min` - .x)) %>% 
  pivot_longer(cols = c(ends_with("min"),"24hrs"),
               names_to = "time",
               values_to = "MB_q") %>% 
  # 吸着量に変換。予め活性炭量が0gの行を除外。
  filter(crbn_amt > 0) %>% 
  mutate(MB_q = MB_q * (500/1000) / crbn_amt) %>% # 活性炭1gあたり
  # あとは一つ前とまったく同じ
  mutate(time = case_when(
    str_detect(time,"min$") ~ as.numeric(str_extract(time,"\\d+")),
    .default = 1440
  )) %>% 
  filter(!is.na(MB_q))
  
  #濃度Cの情報を追加
  output_timenum <- df %>% 
  mutate(time = case_when(
    str_detect(time,"min$") ~ as.numeric(str_extract(time,"\\d+")),
    .default = 1440
  ))
  
  output <- output %>% 
  left_join(output_timenum,by=c("crbn","MB_init_conc","crbn_amt","time")) 
  
  return(output)
}


abs_calc_qe <- getqe(abs_calc)

abs_calc_qe %>% 
  ggplot(aes(x=time,y=MB_q,group=crbn_amt,color=crbn_amt))+
  geom_point()+
  geom_line(linetype = 2)+
  scale_color_gradient(high = "red", low = "darkblue")+
  labs(
    x="経過時間(分)",
    y="吸着量q(mg/g)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn, MB_init_conc),scales = "free")
```

次に、平衡濃度Ceと平衡吸着量qeの関係を @fig-abs-3 に示す。なお、平衡濃度と平衡吸着量は、各条件での24時間後のデータを用いて算出した。

<!--# 正直このグラフは何の意味があるのか…。吸着等温線と操作線の交点ってこと? -->

```{r fig-abs-3, dev='jpeg'}
#| fig-cap: "平衡濃度Ceと平衡吸着量qeの関係"
#| warning: false

abs_calc_qe %>% 
  filter(time==1440) %>% 
  ggplot(aes(x=MB_conc,y=MB_q))+
  geom_point()+
  labs(
    x="平衡濃度Ce(mg/L)",
    y="平衡吸着量qe(mg/g)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn),scale="free")
```

@fig-abs-3 に示した吸着平衡時のデータを用いてラングミュア・プロットを行うと @fig-langmuir のように、点はほぼ直線上に並んだ。また、フロイントリッヒ・プロットを @fig-freundlich に示した。フロイントリッヒ・プロットは、ラングミュア・プロットと比べて直線回帰の決定係数が小さくなってしまった。

```{r fig-langmuir, dev='jpeg'}
#| fig-cap: "Langmuir-plot"
#| warning: false

abs_calc_qe %>% 
  filter(time==1440) %>% 
  mutate(ce_qe = MB_conc / MB_q) %>% 
  ggplot(aes(x=MB_conc,y=ce_qe))+
  geom_point()+
  geom_smooth(method = lm, color="black", linetype=3)+
  stat_poly_eq(use_label(c("eq","R2")))+
  labs(
    x="Ce",
    y="Ce/qe"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn))
```

```{r fig-freundlich, dev='jpeg'}
#| fig-cap: "Freundlich-plot"
#| warning: false

abs_calc_qe %>% 
  filter(time==1440) %>% 
  mutate(log_qe = log(MB_q),
         log_ce = log(MB_conc)) %>% 
  ggplot(aes(x=log_ce,y=log_qe))+
  geom_point()+
  geom_smooth(method = lm, color="black", linetype=3)+
  stat_poly_eq(use_label(c("eq","R2")))+
  labs(
    x="log(Ce)",
    y="log(qe)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn))
```

```{r fig-abs-3-isthm, dev='jpeg'}
#| include: false
#| fig-cap: "平衡濃度Ceと平衡吸着量qeの関係"
#| warning: false

abs_calc_qe %>% 
  filter(time==1440) %>% 
  mutate(lang = case_when(
    crbn=="GW"~ (1/0.00638)*MB_conc/(1+(0.00638/0.00461)),
    crbn=="GLW"~ NA
      )) %>% 
  mutate(fr = case_when(
    crbn=="GW"~exp(0.135)*MB_conc^4.42,
    crbn=="GLW"~exp(0.0342)*MB_conc^6.36
  )) %>% 
  ggplot(aes(x=MB_conc,y=MB_q))+
  geom_point()+
  geom_point(aes(x=MB_conc,y=fr),color="blue")+
  geom_point(aes(x=MB_conc,y=lang),color="red")+
  labs(
    x="平衡濃度Ce(mg/L)",
    y="平衡吸着量qe(mg/g)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn),scale="free")
```

### ガス吸着による細孔分布解析

以下ではBelsorpの元データを活用し、吸着等温線とt-plotを描画することにより、2種の活性炭の違いについて考察する。

まず、.DATファイルから抽出したBelsorpの生データを @tbl-bel-raw に、等温吸着曲線を @fig-abs-isthm に示した。GW活性炭(浄水処理用)は、ほぼLangmuir型の吸着等温線(IUPAC\[ @iupac \]のType Ⅰ)に従っていることがわかる。その一方で、GLC活性炭においては、相対圧が1付近でも吸着量の立ち上がりが見られる。これはIUPACによる分類においてはType Ⅱに近く、単分子吸着の後に多層吸着が起こっていると推測される。また、両者を比較した際、Langmuir型の単分子層吸着領域での吸着量がGW活性炭よりもGLC活性炭の方が多い結果となっている。

次に、@fig-t-plot に各活性炭のt-plotを示す。t-plotとは、「測定した窒素吸着量を、非多孔性吸着媒の吸着層厚さtと比較することにより活性炭の表面積を解析する」( @japan )ためのものである。なお、tの算出には、参考にした文献にならって、Dollimoreら(1969)の論文 @Dollimore を参照し、de Boerらが提案した式である @eq-de_Boer を用いた。Dollimoreらは複数の計算方法を比較し、de Boerらの式が最も適していると結論づけている。なお、Dollimoreらが検証に用いていたのはシリカ及びアルミナである。この論文の結果をそのまま活性炭に適用するのが適切であるかどうかまではわからなかったが、今回はこの式を用いてプロットを行っている。

$$
t = 354(\frac{-5}{ln(P_e/P_0)})^{1/3}
$$ {#eq-de_Boer}

Microtrac BEL社がweb上で公開している資料( @bel )を参考に、t-plotの解釈を行った。今回作成したt-plotにおいては、GW活性炭は原点付近でほぼ垂直に曲線が立ち上がった後、急速にプラトーに転じている。これは、マイクロ孔で吸着が起こった後、「マイクロ孔への N2 の充填が終了すると傾きが⼩さく」( @bel )なった結果であると考えられる。その一方で、GLC活性炭においては立ち上がりはGW活性炭と同様、ほぼ垂直となっているが、その後の傾きの減少具合がゆるやかになっている。これは、GW活性炭にはない、比較的大きな細孔が吸着に関わっていることを示唆している。なお、本当はt-plotを描画した後に、JISに定められた公定法によるt-plotの解析や、MP法による細孔分布図の作成などを行いたいと思っていたものの、残念ながら〆切に間に合わなかったため、今回は割愛する。

```{r calc-belsorp-data}
#| warning: false

# GLCのデータ読み込み
GLC_bel_lines <- readLines("data/GLC1203.txt") %>% 
  stringr::str_split('\t')
GLC_df <- GLC_bel_lines[37:83] %>% #現実的妥協（汗）
  unlist() %>% 
  matrix(ncol=6,byrow = TRUE) %>% 
  as.data.frame.array() %>% 
  select(-c("V1","V6")) %>% 
  `colnames<-`(c("Pe","P0","Vd","V")) %>% 
  mutate_all(as.numeric)
rm(GLC_bel_lines)

# GWのデータ読み込み
GW_bel_lines <- readLines("data/GW1203.txt") %>% 
  stringr::str_split('\t')
GW_df <- GW_bel_lines[37:74] %>% #現実的妥協（汗）
  unlist() %>% 
  matrix(ncol=6,byrow = TRUE) %>% 
  as.data.frame.array() %>% 
  select(-c("V1","V6")) %>% 
  `colnames<-`(c("Pe","P0","Vd","V")) %>% 
  mutate_all(as.numeric)
rm(GW_bel_lines)

# データ描画用のmanipulation
# t-plotに用いるde Boir式
de_Boer <- function(P, P0){
  return(354 * (-5 / log(P / P0)) ^ (1/3) / 100) #pm->nm
}

GLC_df <- GLC_df %>% 
  mutate(sample = "GLC",
         prsr = Pe / P0,
         t_nm = de_Boer(Pe, P0),
         BET = Pe / (V * (P0 - Pe)))
GW_df <- GW_df %>% 
  mutate(sample = "GW",
         prsr = Pe / P0,
         t_nm = de_Boer(Pe, P0),
         BET = Pe / (V * (P0 - Pe)))
```

```{r tbl-bel-raw}
#| tbl-cap: "吸着等温線の生データ"

rbind(GLC_df,GW_df) %>% 
  select(c("Pe","P0","Vd","V","sample")) %>% 
  group_by(sample) %>% 
  gt() %>% 
  tab_options(latex.use_longtable = TRUE)
```

```{r fig-abs-isthm, dev='jpeg'}
#| warning: false
#| fig-cap: "2種の活性炭の吸着等温線"

isthm_plt <- rbind(GLC_df, GW_df) %>% 
  ggplot(mapping=aes(x=prsr, y=V, color=sample))+
  geom_point()+
  labs(
    x="相対圧 P/P0",
    y="吸着量" # 正確な定義を記入する必要あり！
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

isthm_plt
```

```{r fig-t-plot, dev='jpeg'}
#| warning: false
#| fig-cap: "2種の活性炭のt-プロット"

rbind(GLC_df, GW_df) %>% 
  ggplot(mapping = aes(x=t_nm,y=V,color=sample))+
  geom_point()+
  labs(
    x="t(nm)",
    y="窒素吸着量 V"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

## 考察

### 実験結果の補正

まず、サンプリングによる影響の補正は必要ない。なぜなら、サンプリング時には活性炭と原水を両方採取しており、溶液内の活性炭濃度・メチレンブルー濃度はともに、各サンプリングの前後で変化していないと考えられるからである。

その一方で、水の蒸発による影響は活性炭・メチレンブルー濃度の上昇を引き起こすため、補正が必要な可能性がある。実験に使用したビーカーのうち1つについて、t=120minでの採水後と、t=24hでの採水後の質量の変化を測定したところ、ビーカー全体の質量は692.98gから663.37gと、 `r 692.98-663.37` g減少している。この間に10mLの採水を1回行っているため、22時間で蒸発した水の質量は、溶液の密度を1g/mlとすると `r 692.98-663.37-10` gと求められる。

補正による吸着等温線の変化を確認するため、以下の条件でデータの補正を行った。

-   水の蒸発量は実験全体を通して一定とする。\
    根拠：水が空気と触れる面積は、ビーカーの断面積とほぼ等しく、実験を通して変化することはないから。

-   t=0で500mLであったと仮定し、サンプリングのみの影響を加味して、蒸発がなかった場合の水量を計算する。

-   22時間での蒸発量18.91gを加味して、先程求めた水量を補正することで、実際の水量を求める。

-   上記2つの水量の比によって溶液のメチレンブルー濃度を補正する。

-   補正した濃度を用いて吸着量を求め、平衡吸着時(t=24h)についてプロットを行う。

計算を行った結果、ラングミュア・プロットならびにフロイントリッヒ・プロットは @fig-evap-lang と @fig-evap-fr のようになった。ラングミュア・プロット・フロイントリッヒ・プロットともに、もとのプロットよりも直線に近づいていることがわかる。ここから、この補正が有効であることがわかる。

```{r calc-abs-evap}
# abs-calcを修正していく。
# 各時間ごとの修正用係数
# 使わないところはNAにしちゃってます
evap_update <- 
  tribble(~time, ~evap_const,
          "0min",1,
          "5min",1,
          "10min",1,
          "20min",1,
          "30min",1,
          "60min",1,
          "90min",1,
          "120min",1,
          "24hrs",(500-90-18.91*24/22)/500)

abs_evap_update <- abs_calc %>% 
  left_join(evap_update,by="time") %>% 
  mutate(MB_conc = MB_conc * evap_const) %>% 
  select(-evap_const) %>% 
  getqe()
```

```{r fig-evap-lang, dev='jpeg'}
#| warning: false
#| fig-cap: "修正後のラングミュアプロット"

abs_evap_update %>% 
  filter(time==1440) %>% 
  mutate(ce_qe = MB_conc / MB_q) %>% 
  ggplot(aes(x=MB_conc,y=ce_qe))+
  geom_point()+
  geom_smooth(method = lm, color="black", linetype=3)+
  stat_poly_eq(use_label(c("eq","R2")))+
  labs(
    x="Ce",
    y="Ce/qe"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn))
```

```{r fig-evap-fr, dev='jpeg'}
#| warning: false
#| fig-cap: "修正後のフロイントリッヒプロット"

abs_evap_update %>% 
  filter(time==1440) %>% 
  mutate(log_qe = log(MB_q),
         log_ce = log(MB_conc)) %>% 
  ggplot(aes(x=log_ce,y=log_qe))+
  geom_point()+
  geom_smooth(method = lm, color="black", linetype=3)+
  stat_poly_eq(use_label(c("eq","R2")))+
  labs(
    x="log(Ce)",
    y="log(qe)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn))
```

### 吸着等温線の適合性について

@fig-langmuir と @fig-freundlich に示した通り、Langmuir型吸着等温線には良く適合を示した一方で、Freundlichプロットにおいては、概ね右上がりの傾向を示してはいるものの、点は一直線上に分布しない結果となった。一方で、前項のように濃度の補正を行った場合は、Freundlichプロットにおいても、直線に近い形で値が分布するようになった。今回は単分子吸着が主であったため、Langmuir型に良く適合していたのではないかと考えられる。

### 活性炭の比表面積と吸着性能について

Belsorpによる解析の結果、GW活性炭の全部比表面積が1411.6(m\^2/g)であったのに対し、GLC活性炭は2087.3(m \^2/g)と、約1.5倍の違いがある。Belsorpによる解析の結果からもわかる通り、今回は2種の活性炭ともに、マイクロ孔による単相吸着が主として起こっていたと考えられるため、表面積が2種の活性炭の性能を分ける要因となっていたと考えられる。加えて、MP法による細孔分布解析においては、GLC活性炭の方が孔径が大きいということがわかっている。GLCのほうが大きな細孔を持っていたため、メチレンブルーを多く吸着していたと考えられる。メチレンブルー吸着実験においても、平衡吸着量に数倍の差がみられていたが、この結果は、GLC活性炭の細孔ならびに、総表面積の大きさがGW活性炭よりも大きいことが原因であったと考えられる。

### 実務の場での活性炭処理について

実際の浄水処理においては、粉末活性炭と粒状活性炭は目的に応じて使い分けられている。粉末活性炭は主に、原水の汚濁時などに、凝集処理の前に汚濁物質を集中的に除去するために用いられる。専用の設備が少なくて済む一方で、作業員への負担が大きいことや、汚泥量が増加するといった欠点がある。

その一方で、粒状活性炭処理は、活性炭を充填した活性炭吸着池に水を通す形で処理が行われるため、粉末活性炭処理よりも処理効果が高い。さらに、活性炭本来の吸着作用に加え、粒状活性炭表面の微生物叢によって有機物が分解されるという効果もある。なお、生物による有機物分解作用を積極的に利用する場合には生物活性炭処理と呼ばれるが、水道施設設計指針によれば、粒状活性炭処理を行った時点で、活性炭表面には何かしらの微生物が生息しており、多少の分解効果が発揮されるとのことである。このように、粉末活性炭に比べて処理効果の高い粒状活性炭処理であるが、専用の接触設備を建設する必要があるため、コストが高いという欠点がある。

# 課題D オゾンによる有機物分解

## 実験概要

### 実験原理

オゾン処理においては、オゾンの強力な酸化力によって高分子の難分解性有機物が酸化分解される。オゾンは、オゾン分子そのものによる酸化と、ヒドロキシラジカルによる酸化の2種類の反応を引き起こし、後者の方が酸化力が高いため効率が良い。水中のオゾンの動態は、pHによって影響を受け、pHが高いほど、水中でのヒドロキシラジカルの濃度が高くなるため、全体としての酸化反応効率が高くなる。

そこで本実験では、pHがオゾンによる有機物分解に与える影響を調べるため、酸性・中性・アルカリ性の3種類の緩衝溶液にメチレンブルーを一定量加え、オゾン通気を行った。一定時間ごとにオゾン通気中のフラスコから採水を行い、メチレンブルー濃度(2分毎)、TOC濃度、pH、オゾン濃度(最初と最後)の測定を行った。メチレンブルー濃度の測定に当たっては、吸光度法(665nm)を用いた。メチレンブルーは吸着性が高いことから、吸光度測定時には石英セルではなくプラスチックセルを使用し、こまめにMilli-Q水を測定することでセルに吸着していないかを確かめた。溶存オゾン濃度はHACH社の簡易キットを用いてインディゴ法で測定した。TOC濃度測定には島津製作所TOC-Vを使用した。

### 実験手順

実験の詳細な手順を以下に示す。

1.  予め分光光度計の電源を入れ、内蔵ランプの出力を安定させる

2.  試薬調整\
    以下の試薬・溶液を調整する。

-   pH2, pH7.2, pH12の緩衝溶液
    -   pH2:
    -   pH7.2:
    -   pH12:
-   メチレンブルー標準原液(1g/L)
    -   緩衝溶液にはこの標準原液を、500mLあたり25mL添加した。

3.  検量線の作成\
    結果の章で示すように、0mg/L\~20mg/Lの範囲で標準列を作成した上で、検量線が線形性を保つ範囲のデータを採用した。
4.  オゾン通気準備(2, 3と同時並行)\
    オゾン発生器を起動し、3\~5分間バイパスで湿気を追い出した。その後、Milli-Q水500mLに5分間通気し、溶存オゾン濃度を測定した。各条件での実験終了後も、同様にMilli-Q水に通気してオゾン濃度を測定することで、オゾン発生器から発生しているオゾン濃度が一定であるかどうかを確認した。
5.  オゾン処理\
    実験原水(緩衝溶液500mLにメチレンブルー標準原液25mLを添加)を反応器に入れ、オゾンを通気する。オゾン通気開始直前をt=0とし、2分ごとに採水する。
6.  水質分析\
    採水したサンプルについて、メチレンブルー濃度(全サンプル)、TOC濃度・pH・オゾン濃度(最初と最後のサンプル)を測定する。

## 結果

まず、メチレンブルー濃度算出に用いる検量線を作成した。各班の実測値を @tbl-ozn-calib に示す。

```{r tbl-ozn-calib}
#| tbl-cap: "オゾン検量線の元データ"

# オゾンのデータ読み込み
ozn_calib <- read.csv("data/ozone_calib.csv")

# 検量線用の希釈列データの表組み
ozn_calib %>% 
  filter(班==3) %>% 
  arrange(メチレンブルー濃度.mg.L.) %>% 
  select(-c("班")) %>% 
  gt() %>% 
  cols_align(
    align="center",
    columns=everything()
  ) %>% 
  cols_label(メチレンブルー濃度.mg.L.="MB濃度(mg/L)",
             吸光度="665nm吸光度")
```

<!--# ここの表現もうちょっと洗練させたいなぁ。。 -->

上記のデータを用いて最小二乗法で検量線を作成したところ、今回採用した希釈段階の全域に渡ってデータは線形な変化であることを確認することができた。検量線モデルは、R言語の`lm`関数により、吸光度を目的変数、メチレンブルー濃度を説明変数とした線形回帰を行うことにより導出した（以下同様）。

```{r fig-ozn-calib, dev='jpeg'}
#| warning: false
#| fig-cap: "メチレンブルー濃度の検量線"

# 検量線プロット
ozn_calib %>% 
  filter(班==3) %>% 
  ggplot(mapping = aes(x=メチレンブルー濃度.mg.L., y=吸光度))+
  geom_point()+
  geom_smooth(method="lm",color="black")+
  labs(
    #title="メチレンブルー濃度の検量線",
    x="メチレンブルー濃度(mg/L)",
    y="665nm吸光度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))
```

@fig-ozn-calib の検量線を用いて、各時刻でのメチレンブルー濃度を算出した。pH・オゾン濃度・TOC濃度の実測値と合わせ、 @tbl-ozone に結果を示す。

検量線法による濃度推定を行うに当たっては、ブランク試料を測定した際の吸光度を下回ったサンプルは「検出限界以下」として扱った。この点について気になり調査したが、一般的にはIUPAC発行の"Compemdium of Chemical Terminology"の記載に則り、 @eq-LOD-and-LOQ と @eq-LOQ に示したような定義が用いられるとのことである。($※ただし、a: ブランクの平均、\sigma: ブランクの標準偏差$)

<!--# ここ、出典がgolden bookとagilientのサイトの3つが必要！ -->

$$
LOD(Limit\ of\ Detection) = a + 3\sigma\\   
$$ {#eq-LOD-and-LOQ}

$$
LOQ(Limit\ of\ Quantification) = a + 6\sigma\\
$$ {#eq-LOQ}

しかしながら、今回の実験演習ではブランクの測定を1回しか行っていないため、ブランク試料の標準偏差を求めることができず、統計学的な検出限界ならびに定量限界を求められない。そこで今回はやむを得ず、1回だけ測定したブランク試料の吸光度を機器のノイズレベルとみなし、ブランク試料の吸光度を下回ったサンプルを定量限界を下回ったサンプルとして処理することにした。本レポートにおいて検量線法を用いている他の実験においても同様の処理を行った。（例： @tbl-ozone に示した計測結果の場合は、ブランクの吸光度は0.000だったため、吸光度の測定結果が負となったサンプルが「測定限界」として表記されている。）

```{r calc-MB-conc}
#検量線を用いて濃度を算出する。吸光度測定時の希釈倍率も考慮。
# 回帰モデルの作成
lm_ozn_dat <- ozn_calib %>% 
  filter(班==3) 
lm_ozn <- lm(lm_ozn_dat$吸光度 ~ lm_ozn_dat$メチレンブルー濃度.mg.L.,
             model = TRUE)



# 実験データの読み込みと検量線モデル適用
ozone <- read.csv("data/ozone.csv")
ozone <- ozone %>% 
  mutate(ozn_mdlfit = map(吸光度, inverse_pred, lm_mod = lm_ozn)) %>% 
  unnest(ozn_mdlfit) %>% 
  mutate(MB_conc = MB_conc * 吸光度_希釈)
```

```{r calc-ozone-TOC}
# TOCデータ読み込みと抽出
TOC_1_2 <- read.csv("data/TOC_ozone_1_2.csv", header = FALSE)
TOC_3_4 <- read.csv("data/TOC_ozone_3_4.csv", header = FALSE) %>% 
  filter(V4=="NPOC") %>% 
  select(c("V3", "V9")) %>% 
  `colnames<-`(c("TOC_vial","TOC_conc")) %>% 
  mutate_all(as.numeric) #%>% 
  #mutate(TOC_filename = "1_2")

# 実験ノートのデータと統合
ozone <- ozone %>% 
  left_join(TOC_3_4, by="TOC_vial")
```

```{r tbl-ozone}
#| tbl-cap: "オゾン処理時の各水質指標の測定結果"

# 実験データの表組み
ozone %>%
  filter(班==3) %>% 
  select(-c("班","TOC_vial","TOC_filename")) %>% 
  group_by(条件) %>% 
  gt() %>% 
  text_transform(
    locations = cells_body(columns = starts_with("MB_"),
                           rows = MB_info == "<LOD"),
    fn = function(x) {x = "定量限界以下"}
  ) %>% 
  fmt_number(decimals = 1,
             columns = c("MB_conc", "TOC_conc")) %>% 
  tab_spanner(label = "メチレンブルー濃度測定",
              columns = c("吸光度","吸光度_希釈","MB_conc")) %>% 
  cols_hide(columns = c("MB_info")) %>% 
  cols_label(時間.分. = "時刻(分)",
             吸光度_希釈 = "希釈倍率",
             MB_conc = "濃度(mg/L)",
             O3_conc = "オゾン濃度(mg/L)",
             TOC_conc = "TOC濃度(mg/L)") %>% 
  cols_align(align = "center", columns = everything()) %>% 
  sub_missing(missing_text = "-")
```

酸性のt=0でのサンプルの吸光度の値が、t=2での値よりも小さくなってしまっている。酸性・中性・アルカリ性の各条件について、TOCの値は約15前後で一定しているため、メチレンブルー溶液の投入量を間違えた可能性は低い。従って、吸光度測定の時点で、希釈倍率を間違えるなどの手違いがあったと推測される。

メチレンブルー濃度の時間変化を図示すると @fig-MB-conc のようになった。

```{r fig-MB-conc, dev='jpeg'}
#| warning: false
#| fig-cap: "メチレンブルー濃度の経時変化"

ozone %>% 
  filter(班==3) %>% 
  select(c("時間.分.","MB_conc","条件")) %>% 
  ggplot(mapping=aes(x=時間.分. , y=MB_conc, color=条件)) +
  geom_point(size =2) +
  geom_line(linetype = 3, linewidth = 1) +
  labs(
    x="時間(分)",
    y="メチレンブルー濃度(mg/L)"
  ) +
  theme_bw() +
  theme(text=element_text(family=hiragino))
```

## 考察

#### 実測データについて

酸性条件でのt=0のデータが不可解である。希釈倍率を間違えたなどの原因が考えられる。メチレンブルーの除去量に関しては、どのpHにおいても最初の2分間で9割近くが分解されてしまっている。その後は、酸性・中性においては、吸光度法による測定限界以下の濃度に下がっている中、アルカリ性においてはメチレンブルーが低濃度で残存している結果となった。その一方で、TOCの除去量に注目すると、酸性、中性、アルカリ性の順に、2.4、1.6、4.0となっており、アルカリ性の場合に有機物除去効果が最も高くなっており、この点については、理論と一致することがわかる。

当日の実験においては、pHが高い条件下でヒドロキシラジカルの割合が大きくなった結果、その強い酸化力により、メチレンブルーを分解して無色化することに加え、より低分子の有機物へと分解が進んでいたのではないだろうか。その結果、メチレンブルーの吸光度は他の2条件に比べて多いものの、TOC濃度が減少していたと考えられる。

#### 実務でのオゾン処理について

オゾン処理は実際の浄水場においては、異臭味や色度、トリハロメタン前駆物質などの除去を目的として広く導入されている。特に、生物活性炭と組み合わせた難分解性有機物がオゾンにより分解された後、活性炭に吸着され、生息する生物によって完全に分解されるという流れで、有機物を効率的に除去することが可能である。しかしながら、オゾン処理には、コストがかかる、廃オゾン設備が必要である、アルデヒドなどの副生成物を生じるという問題がある。そのため、カビ臭やフミン質などが特に目立つ原水を処理しなければならない場合に、オゾンは効果を発揮すると考えられる。

# 課題E-1 塩素消毒

## 実験概要

塩素は注入処理が容易なことや、処理後も残留効果を示すことから、古くから主要な消毒方法として用いられ続けてきた。

塩素は水中では以下の反応を通じて次亜塩素酸 $HOCl$ ならびに次亜塩素酸イオン$OCl^-$を生じ、２つは「遊離塩素」と総称されている。水中で負に帯電している微生物に対しては次亜塩素酸の方が高い殺菌力を持つ。

本実験演習では、水道水ならびにpH6.5・pH8.5の緩衝溶液(塩素添加)に大腸菌を加え、経時的にサンプリングを行って大腸菌濃度を計測することで、遊離塩素の消毒効果について定量的に把握する。遊離塩素濃度に関しては実験前と実験後の2回測定する。

## 結果

各条件下でのコロニー数の計数結果を @tbl-cl-colony に示す。以降の考察では他班のデータも参照しているため、すべての班の計数結果について記載した。各サンプルにおける希釈倍率と観測されたコロニー数の関係には齟齬はなく、希釈時操作に関わるミス(希釈溶液の試験管の取り違えなど)は起こっていなかったと推測される。その一方で、4班の結果においては、t=t1以降のほとんどのサンプルにおいて、最小希釈倍率を10\^1倍に設定しているにもかかわらず、コロニーが１つも見られない結果となった。この点に関しては、採水後にチオ硫酸ナトリウムを入れ忘れており、塩素が消毒効果を発揮し続けたため、菌が全量不活化されてしまったのではないかと推測される。（4班の人に聞いてみたところ、「入れたはずだけど、よく覚えていない」とのことであった。もしかすると、誤ってMilli-Qなど、チオ硫酸ナトリウムではない溶液の入ったビーカーをチオ硫酸ナトリウムと思い込んで添加していたのかもしれない。）

```{r util-read-colony}
colony <- read.csv("data/colony.csv")
```

```{r tbl-cl-colony}
#| message: false
#| tbl-cap: "大腸菌コロニー数の計数結果(塩素消毒)"

# table formatting
colony %>% 
  mutate(班=paste0(班,"班")) %>% 
  filter(実験名=="塩素") %>% 
  select(-"実験名") %>% 
  group_by(班,サンプル名,採水時刻,希釈倍率) %>%
  mutate(コロニー数=paste(コロニー数,collapse = "/")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  mutate(コロニー数=paste0(
    "\\textbf{",コロニー数,"}","(×$10^",希釈倍率,"$)"
    ),
    コロニー数=paste0(コロニー数, collapse=", ")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  gt() %>% 
  #tab_header(title="大腸菌コロニー数の計数結果") %>% 
  fmt_passthrough(
    columns = コロニー数,
    escape=FALSE
  ) %>% 
  cols_align(align="center", columns=c("コロニー数","採水時刻")) %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

次に、実験前後での遊離塩素濃度の測定結果、塩素消費における一次反応速度定数k'の推定値ならびに、実験での実際の採水時刻t1\~t3を @tbl-chlorine に示す。

```{r tbl-chlorine}
#| message: false
#| tbl-cap: "各班の遊離塩素濃度・採水時刻の実測値"

# データ読み込み
chlorine <- read.csv("data/chlorine.csv")

# k'の計算
chlorine <- chlorine %>% 
  mutate(k_dash = - (60/t4) * log(cl_aftr / cl_bef))

# 遊離塩素濃度の表組み
chlorine %>% 
  mutate(班 = paste0(班,"班")) %>% 
  group_by(班) %>% 
  gt() %>% 
  cols_label(cl_bef = "実験前",
             cl_aftr = "実験後",
             t4 = "測定時刻(s)",
             サンプル名 = "溶液",
             k_dash = "k'(/min)") %>% 
  tab_spanner(columns = c("t1","t2","t3"),
              label = "採水時刻(s)") %>% 
  tab_spanner(columns = c("cl_bef","cl_aftr","t4"),
              label = "遊離塩素濃度(mg/L)") %>% 
  fmt_scientific(columns = "k_dash",
                 n_sigfig = 2) %>% 
  sub_missing(missing_text = "-")
```

塩素の初期濃度と終濃度から推定した塩素分解の一次反応速度定数k'の値を元に各時刻でのCt値を算出し、Ct値と対数不活化率の関係を @fig-cl-inact にプロットした。先述の通り、4班は実験操作過程において何等かの不手際があったと考えられるため、以降の解析から除外した。3班の緩衝液BのCt値算出にあたっては、終塩素濃度の測定を忘れてしまったため、他の班の緩衝液Bにおけるk'の平均値(n=3)で代替した。また、WHOの指針によれば、pH6〜7、水温5°Ｃの場合、遊離塩素で大腸菌を2log不活化するのに必要なCt値は0.034-0.05(mg/L\*min)とされていることを踏まえ、該当する不活化率・Ct値の範囲をグラフ上に青の線分で示した。

```{r fig-cl-inact, dev='jpeg'}
#| warning: false
#| fig-cap: "対数不活化率とCt値"

# まずはCt値を計算
chlorine_ct <- chlorine %>% 
  mutate(k_dash = case_when(is.na(k_dash)~ 0.5175782, .default = k_dash)) %>% # 3班の緩衝液Bのk'を他の平均値で埋める
  pivot_longer(cols = c("t1","t2","t3"),
               names_to = "採水時刻",
               values_to = "t_sampling") %>% 
  mutate(ct = cl_bef * (1/k_dash) * (1 - exp(-k_dash * (t_sampling/60)))) %>% # 単位はmg/L/min
  select(c("班","サンプル名","採水時刻","ct")) # 他3列は菌数との照合用

# 大腸菌濃度を計算(各サンプルの量は10mLとする)
colony_ct <- colony %>% 
  filter(実験名=="塩素", 採用希釈倍率=="*") %>% 
  select(-実験名) %>% 
  left_join(chlorine_ct, by=c("班","サンプル名","採水時刻")) %>% 
  mutate(ct = case_when(採水時刻=="t0" ~ 0,
                        .default = ct)) %>% 
  # グラフ表示用に計算していく
  mutate(コロニー数 = case_when(コロニー数=="<1"~0,
                           .default = as.numeric(コロニー数)),
         coli_conc = コロニー数 * 10^希釈倍率) %>% 
  group_by(班,サンプル名,採水時刻) %>% 
  summarise(coli_conc = mean(coli_conc),
            ct = unique(ct),
            .groups = "drop") %>% 
  group_by(班,サンプル名) %>% 
  reframe(surv = coli_conc / max(coli_conc),
          ct = ct,
          採水時刻 = 採水時刻)

# 不活化速度定数算出のためのプロット
colony_ct %>%
  filter(班!=4) %>% 
  mutate(班=paste0(班,"班"),
         surv_log= -log10(surv)) %>% 
  mutate(サンプル名 = case_when(
    サンプル名 == "水道水" ~ "水道水(pH約7)",
    サンプル名 == "緩衝液A" ~ "緩衝液A(pH約6.5)",
    サンプル名 == "緩衝液B" ~ "緩衝液B(pH約8.5)")) %>% 
  ggplot(aes(x=ct,y=surv_log))+
  geom_point(aes(shape=班),size=3)+
  #geom_smooth(method="lm",linetype=3)+
  geom_line(aes(color=班),linetype = 3)+
  geom_segment(aes(x=0.034,xend=0.05,y=2), color="blue")+
  facet_wrap(vars(サンプル名),scale="free",ncol=3)+
  labs(
    x="Ct値",
    y="対数不活化率"
  )+
  #ggpmisc::stat_poly_eq(use_label(c("eq","R2")))+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

水道水に関しては、1班は時刻t2の時点で菌がほぼ全量不活化、2班は全域でほぼ線形に不活化率が変化しているのに対し、3班は時刻t1まで他2班とほぼ同水準で不活化が起こった後、テーリングが起こっている。緩衝液Aは、3班ともに、時刻t1まではほぼ同程度で不活化した後、時刻t2以降でテーリングが生じている。緩衝液Bについては、1班はt=t1の時点で一切不活化が起こっていない点が不可解である。t=t2以降は不活化していることを踏まえると、大腸菌が凝集していた、撹拌が十分に行われなかったなどの理由により、塩素との接触が十分に行われていなかったと考えられる。その一方で、大腸菌の凝集だけでは、時刻t2以降は3log以上の水準で一気に不活化が起こっていることが説明できない。この現象に関して、何等かの科学的に説明可能な理由が存在する可能性は否定できない。しかしながら今回は、時刻t1で一切不活化していない時点で、時刻t=0から塩素濃度が一次反応に従って分解するという今回の反応モデルを1班の実験データには適用することができないと判断し、緩衝液Bにおける不活化速度定数ｋの計算では1班のデータを除いて考えることとした。

以上の議論より、不活化反応速度定数kは、以下のような基準で計算を行った。

-   水道水：3班が時刻t2からテーリングを生じているため、全体の回帰直線を求めることは適切ではない。従って、すべての班について、時刻t0・t1の2点を結ぶ直線の傾きをkの推定値として統一する。

-   緩衝液A：全班すべてにおいて時刻t2以降でテーリングが生じているため、水道水と同様に、原点と時刻t1の点を結ぶ直線の傾きを採用する。

-   緩衝液B：先述の理由から、1班のデータは採用しない。2・3班のデータはどちらも、全時刻を通してほぼ対数不活化率は単調に増加している。そのため、2班それぞれのデータについて、原点・t1・t2・t3の4点から回帰直線を導出し、その傾きをkの推定値とする。

以上の基準で不活化速度定数kを算出した結果を @tbl-k-calc に示す。また、3条件での不活化速度定数の比較を @fig-k-calc に示す。各条件について、棒グラフは平均値、エラーバーは標準偏差を示している。

```{r tbl-k-calc}
#| message: false
#| tbl-cap: "不活化速度定数kの推定値"

cl_k_calc <- colony_ct %>% 
  filter(班!=4) %>% 
  mutate(surv_log = -log10(surv)) %>% 
  select(-surv) %>% 
  filter((サンプル名=="水道水" & 採水時刻%in%c("t0","t1")) |
           (サンプル名=="緩衝液A" & 採水時刻%in%c("t0","t1")) |
           (サンプル名=="緩衝液B" & 班!=1)) %>% 
  group_by(サンプル名,班) %>% 
  nest() %>% 
  mutate(lm = map(data, function(df) lm(df$surv_log ~ df$ct))) 

# 表組み(回帰モデルの傾きを表示)
cl_k_calc <- cl_k_calc %>% 
  mutate(k_val = map(lm,function(mod){
    format(unname(mod$coefficients[2]),digits=3)
                         })) %>% 
  select(c("班","サンプル名","k_val")) %>% 
  mutate(k_val = as.numeric(k_val)) 

cl_k_calc %>% 
  pivot_wider(names_from = "班",
              values_from = "k_val") %>% 
  gt() %>% 
  fmt_scientific(columns = everything(),
                 n_sigfig = 2)
```

```{r fig-k-calc ,dev='jpeg'}
#| warning: false
#| fig-cap: "不活化速度定数kの条件間での違い"

cl_k_calc %>% 
  group_by(サンプル名) %>% 
  summarise(mean = mean(k_val),
            sd=sd(k_val)) %>% 
  ggplot()+
  geom_bar(aes(x=サンプル名,y=mean),stat="identity",fill="skyblue")+
  geom_errorbar(aes(x=サンプル名,ymin=mean-sd,ymax=mean+sd),
                color="red",width=0.5)+
  labs(
    x="条件名",
    y="不活化速度定数k"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

いくつか実験結果を意図的に除外した結果であるので参考程度には留まるが、今回の計算方法のもとでは、すべての条件どうしで統計的に有意な差が認められる結果となった。

## 考察

まず実験データの完全性については、緩衝液Bにおいて、t=t3での採水後の塩素濃度測定を忘れてしまった。これは、「最初と最後の時点での塩素濃度を測定することにより、一次反応の反応速度定数k'を測定する」という実験のパラメータ計算の流れを完全に理解できていなかったことが原因である。今後は実験の設計・計画を完全に理解した上で実験に臨む習慣をつけたいと思う。

#### 次亜塩素酸・次亜塩素酸イオンの理論存在比率

HOClのpKaは7.5なので @eq-pka-calc が成り立つ。

$$
\frac{[H^+][OCl^-]}{[HOCl]} = 10^{-7.5}
$$ {#eq-pka-calc}

従って、緩衝液A、Bにおける水素イオン濃度(それぞれ $10^{-6.5}, 10^{-8.5}$)を代入すると、Aにおける存在比はHOCl : OCL- = 10:1、Bでは1:10と求まる。

#### HOClとOCl-の不活化能力の違い

各緩衝液におけるkの平均値は、Aで$2.9 \times 10^1$、Bで$4.6$となった。k=kHOCl + kOCl- と仮定した場合、HOClの不活化能力がOCl-のa倍とすると @eq-hocl が成り立つ。この式を解くとaは17となり、HOClの不活化能力はOCl-の17倍高いことがわかる。

$$
\frac{10a+1}{a+10} = \frac{290}{46}
$$ {#eq-hocl}

#### 実務におけるCt値のコントロール

```{r calc-}
k_val_ph8.5 <- cl_k_calc %>% 
  filter(サンプル名=="緩衝液B") %>% 
  pull(k_val) %>% 
  mean()

s_target <- c(1,2,3)
ct_ans <- s_target / k_val_ph8.5
```

緩衝液Bにおける不活化速度定数`r format(k_val_ph8.5, digits=2)` より、今回用いた大腸菌株において90%、99% 、99.9%の不活化を達成するにはそれぞれ、 `r format(ct_ans[[1]], digits=2)`、 `r format(ct_ans[[2]], digits=2)`、 `r format(ct_ans[[3]], digits=2)` のCt値を与える必要がある（生存率10%を1logの不活化として考えた）。

実務におけるCt値の制御について考察するにあたり、金町浄水場や東村山浄水場などの大規模浄水場での塩素接触池の水理学的滞留時間と注入塩素濃度を調査しようと思ったが、資料を見つけることができなかった。従って、いくつか数値を仮定して概算してみたい。

東京都水道局では、広い地域を対象として配水を行うにあたり、浄水場の付近で蛇口での残留塩素濃度が高くなってしまうことを防ぐために、給水所での追加塩素注入を行い、浄水場での注入塩素濃度を減らしている。この事実を鑑み、浄水場での塩素注入ですべての病原微生物を不活化することを目指すよりは、送配水を含めた水道システム全体での水質管理の観点から考えた方が良いのではないかと考えた。そこで、今回は配水所において大腸菌が残存していた場合、どれだけの消毒効果が得られるのかを概算してみることにした。

配水池での水理学的滞留時間を12時間、残留塩素濃度を水道水質基準の上限値である0.4mg/Lで一定と仮定すると、Ct値は$2.9 \times 10^2$となり、今回用いた大腸菌株を99.9%不活化することが十分に可能であるとわかる。また、浄水場から配水所までの送水や、配水所から家庭まで配水の間にも、残留塩素による消毒効果が持続していると考えられ、さらに不活化は進行すると考えられる。以上のような試算から、水道水質基準におけるpHの上限値に近いpH8.5の状態であった場合でも十分な消毒効果が得られ、水道水の微生物学的安全性が保たれるようにインフラが設計されていることがわかる。

#### 塩素感受性の株間多様性の考慮

Ct値と今回の実験で得られた速度定数kを用いると、感受性が30倍の株が1%、30分の1の株が1%混入していた場合の大腸菌集団全体としての生存率は @eq-survival で表される。

$$
生存率S_{all} = 0.98\cdot 10^{-Ct\cdot k}+0.01\cdot 10^{-30Ct\cdot k}+0.01\cdot 10^{\frac{Ct\cdot k}{30}}
$$ {#eq-survival}

この生存率の常用対数の絶対値が全体としての対数不活化率となる。不活化率が1、2、3となるCt値を求めたい。解析的に求解することは難しいため、まずはグラフを描画すると @fig-s-total のようになる。

```{r fig-s-total ,dev='jpeg'}
#| warning: false
#| fig-cap: "大腸菌集団全体の不活化曲線"

surv_all <- function(ct){
  k <- 4.6
  surv <- 0.98*10^(-k*ct) + 0.01*10^(-30*ct*k) + 0.01*10^(-k*ct/30)
  return(-log10(surv))
}

ggplot(data.frame(x = c(0, 10)), aes(x = x)) +
  stat_function(fun = surv_all,
                colour = "red") +
  labs(x = "Ct値",
       y = "集団全体の対数不活化率-logS")+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

```{r calc-s-total}
# s_targetは先程と共通で1,2,3
x_sols <- sapply(s_target, 
                 function(yt) uniroot(function(x) surv_all(x) - yt,
                                      interval = c(0, 10))$root)
```

対数不活化率1、2、3を達成するCt値を、R言語の`uniroot`関数を用いて求めると、それぞれ `r format(x_sols[[1]], digits=2)` 、 `r format(x_sols[[2]], digits=2)`、 `r format(x_sols[[3]], digits=2)`となった。 (3)で計算したCt値がそれぞれ `r format(ct_ans[[1]], digits=2)`、 `r format(ct_ans[[2]], digits=2)`、 `r format(ct_ans[[3]], digits=2)` であったことを踏まえると、不活化率が2logまでであれば必要なCt値はあまり変わらないものの、3log以降は不活化曲線の傾きが小さくなり、必要なCt値がオーダーレベルで変化することがわかる。

このように、塩素消毒耐性を持つ菌株が1%混入しただけでも、全体としての不活化率には大きな影響が及ぼされることがわかる。

# 課題E-2　紫外線消毒

## 実験目的

紫外線消毒は、塩素消毒に対し強い耐性を示すクリプトスポリジウム原虫の対策の必要性が高まったことを背景に、日本でも浄水プロセスにおける導入が進んでいる。原理としては、紫外線の強いエネルギーによって病原微生物のDNAまたはRNAに損傷(チミン二量体などの二量体)が起こり、微生物が自己複製能を失うことによって不活化が起こる。本実験演習では、大腸菌を含む水試料に紫外線を一定時間照射し、複数のタイミングで採水・培養を行うことにより、紫外線消毒の効果を測定する。

また、紫外線消毒の消毒効果の検証においては、光回復ならびに暗回復による再増殖の効果を考慮することが重要となる。そこで今回は、光回復ならびに暗回復に関わる遺伝子が欠損した大腸菌株(KEIOコレクション)を使用し、通常の大腸菌株の不活化プロファイルと比較を行うことにより、紫外線消毒における光回復・暗回復の効果について定量的に理解することを目標とする。

## 結果

各条件下でのコロニー数の計数結果を @tbl-uv-colony に示す。塩素消毒実験時と同じく、各サンプルにおける希釈倍率とコロニー数の関係は一致しており、希釈操作は正しく行われたと推測される。

```{r tbl-uv-colony}
#| message: false
#| tbl-cap: "大腸菌コロニー数の計数結果(紫外線消毒)"

# table formatting
colony %>% 
  filter(実験名=="紫外線") %>% 
  select(-実験名) %>% 
  mutate(班=paste0(班,"班")) %>% 
  group_by(班,サンプル名,採水時刻,希釈倍率) %>%
  mutate(コロニー数=paste(コロニー数,collapse = "/")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  mutate(コロニー数=paste0(
    "\\textbf{",コロニー数,"}","(×$10^",希釈倍率,"$)"
    ),
    コロニー数=paste0(コロニー数, collapse=", ")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  gt() %>% 
  #tab_header(title="大腸菌コロニー数の計数結果") %>% 
  fmt_passthrough(
    columns = コロニー数,
    escape=FALSE
  ) %>% 
  cols_align(align="center", columns=c("コロニー数","採水時刻")) %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

次に、実験前に計測したシャーレ上側の線量率、試料の吸光度から、反応容器内の平均線量率を算出した。実験当日の採取時刻t1\~t3と併せ、@tbl-uv-it に示した。容器内の平均線量率についても計算を行っている。

平均線量率は、Lambert-Beerの法則( @eq-lambert-beer )を0からLまで定積分し、Lで割って得られる @eq-lambert-integral を用いて計算した。

$$
I = I_0 \cdot 10^{-A\cdot L}
$$ {#eq-lambert-beer}

$$
\begin{aligned}
\frac{1}{L} \int_{0}^{L}I_0 \cdot 10^{-A \cdot L'}dL' &=\frac{I_0}{L}(-\frac{1}{Alog10})[10^{-AL'}]_0^L\\
&=\frac{I_0}{ALlog10}(1-10^{-AL})
\end{aligned}
$$ {#eq-lambert-integral}

```{r tbl-uv-it}
#| message: false
#| tbl-cap: "平均線量率と採水時刻"

depth <- 40 / (4.3^2 * pi) # シャーレ(半径4.3cm)内の深さ

uv <- read.csv("data/uv.csv") %>% 
  mutate(uv_ave = (uv_1+uv_2+uv_3+uv_4+uv_5) / 5,
         i_ave = # Lambert-Beer則を積分した式
           uv_ave / (abs*depth*log(10)) * (1 - 10^(-abs*depth))) 
  

# 表組み
uv %>% 
  group_by(班) %>% 
  mutate(班=paste(班,"班")) %>% 
  gt(rowname_col = "サンプル名") %>% 
   cols_label(uv_1="1回目",
             uv_2="2回目",
             uv_3="3回目",
             uv_4="4回目",
             uv_5="5回目",
             uv_ave="平均",
             abs="吸光度",
             i_ave="平均線量率") %>% 
  tab_spanner(columns = c("t1","t2","t3"),
              label = "採水時刻(s)") %>% 
  tab_spanner(columns = starts_with("uv"),
              label = "透過前の紫外線線量率(mW/cm^2)") %>% 
  text_transform(locations = cells_body(columns=c("uv_1","uv_2",
                                                  "uv_4","uv_5","uv_ave"),
                                        rows = c(starts_with("uvr"),
                                                 starts_with("phr"))),
                 fn = function(x) ""
                 ) %>% 
  text_transform(locations = cells_body(columns = "uv_3", rows =  c(starts_with("uvr"), starts_with("phr"))),
                 fn = function(x) "同上") %>% 
  fmt_number(columns = i_ave, decimals=2)
```

計算した平均線量率を用いて各時刻での線量Iを算出し、大腸菌の不活化率との関係をプロットすると @fig-uv-inact のようになる。なお、対数不活化率を求めるにあたり、コロニーが全く見られなかった場合には対数不活化率が正の無限大となってしまうため、"\<1"の場合は便宜的に"コロニー数1"と置き換えて作図を行った。

```{r fig-uv-inact, dev='jpeg'}
#| warning: false
#| fig-cap: "対数不活化率と線量I"

uv_I <- uv %>% 
  select(-starts_with("uv"),-abs) %>% 
  pivot_longer(cols = starts_with("t"),
               names_to = "採水時刻",
               values_to = "t_sampling") %>% 
  mutate(i_val = i_ave * t_sampling) %>% 
  select(-c("i_ave","t_sampling"))

colony_uv <- colony %>% 
  filter(実験名=="紫外線", 採用希釈倍率=="*") %>% 
  select(-実験名,-採用希釈倍率) %>% 
  mutate(コロニー数 = case_when(コロニー数 == "<1" ~ 1,
                           .default = as.numeric(コロニー数)),
         coli_conc = コロニー数 * 10^希釈倍率) %>%
  select(-c("希釈倍率","コロニー数")) %>% 
  left_join(uv_I, by=c("班","サンプル名","採水時刻")) %>% 
  mutate(i_val = case_when(採水時刻=="t0" ~ 0,
                           .default = i_val),
         班=paste0(班,"班")) %>% 
  group_by(班,サンプル名,採水時刻) %>% 
  summarise(coli_conc = mean(coli_conc),
            i_val = unique(i_val),
            .groups = "drop") %>% 
  group_by(班,サンプル名) %>% 
  reframe(surv = coli_conc / max(coli_conc),
          i_val = i_val,
          採水時刻 = 採水時刻)
  
colony_uv %>% 
  mutate(surv_log = -log(surv),
         サンプル名=case_when(サンプル名=="phr"~"Δphr",
                              サンプル名=="uvr"~"Δuvr",
                         .default = "BW")) %>% 
  ggplot(aes(x=i_val,y=surv_log))+
  geom_point(aes(shape=班),size=3)+
  #geom_smooth(method="lm",linetype=3)+
  geom_line(aes(color=班),linetype = 3)+
  geom_segment(aes(x=0.034,xend=0.05,y=2), color="blue")+
  facet_wrap(vars(サンプル名),scale="free",ncol=3)+
  labs(
    x="線量I(mW/cm^2 * t)",
    y="対数不活化率"
  )+
  #ggpmisc::stat_poly_eq(use_label(c("eq","R2")))+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

遺伝子欠損のないBW25113株では、全ての班において不活化曲線はほぼ直線形になり、2班・3班・4班では、時刻t3までにほぼ全量が不活化されている。また、4班の時刻t3の不活化率の減少に関しては、紫外線照射処理後に蛍光灯照明下で回復が起こったのではないかと考えられる。Δphr株では、4班でテーリングが生じている以外は、ほぼ線形な変化となっている。Δuvr株では、4班は時刻t2の時点でほぼ全量が不活化されている一方、時刻t3では微量ながら大腸菌が検出されており、光回復の可能性が示唆される。4班以外では、ほぼ線形に変化している。

以上の議論から、マルチヒットモデルにおいてn=1とした場合の不活化速度定数k(cm\^2/mJ)を、以下のような方法で推定した。

-   BW25113株：2〜4班のデータについては、原点、t1、t2の3点の回帰直線の傾きを求める。1班のデータについては、4点全てを用いる。

-   Δphr株：テーリングが生じた4班は原点、t1、t2の3点を用いる。その他の班は4点全てを用いる。

-   Δuvr株：4班は原点とt1の2点の傾きを用いる。その他は4点全てを用いる。

以上の方法でn=1と仮定した場合のkを算出した結果を @tbl-uv-k に示す。また、3株での不活化速度定数の比較を @fig-uv-k に示す。塩素消毒実験の時と同様、エラーバーは各条件におけるkの標準偏差を示している。

```{r tbl-uv-k}
#| tbl-cap: "不活化速度定数kの算出結果"

uv_k_calc <- colony_uv %>% 
  mutate(surv_log = -log(surv)) %>% 
  select(-surv) %>% 
  filter((サンプル名=="BW" & (班=="1班" | 採水時刻%in%c("t0","t1","t2"))) |
           (サンプル名=="phr" & (班!="4班" | 採水時刻%in%c("t0","t1","t2"))) |
           (サンプル名=="uvr" & (班!="4班" | 採水時刻%in%c("t0","t1")))) %>% 
  group_by(サンプル名,班) %>% 
  nest() %>% 
  mutate(lm = map(data, function(df) lm(df$surv_log ~ df$i_val))) 

# 表組み(回帰モデルの傾きを表示)
uv_k_calc <- uv_k_calc %>% 
  mutate(k_val = map(lm,function(mod){
    format(unname(mod$coefficients[2]),digits=3)
                         })) %>% 
  select(c("班","サンプル名","k_val")) %>% 
  mutate(k_val = as.numeric(k_val)) 

uv_k_calc %>% 
  pivot_wider(names_from = "班",
              values_from = "k_val") %>% 
  gt() %>% 
  fmt_scientific(columns = everything(),
                 n_sigfig = 2)
```

```{r fig-uv-k, dev='jpeg'}
#| warning: false
#| fig-cap: "不活化速度定数kの株間での違い"

uv_k_calc %>% 
  group_by(サンプル名) %>% 
  summarise(mean = mean(k_val),
            sd=sd(k_val)) %>% 
  ggplot()+
  geom_bar(aes(x=サンプル名,y=mean),stat="identity",fill="skyblue")+
  geom_errorbar(aes(x=サンプル名,ymin=mean-sd,ymax=mean+sd),
                color="red",width=0.5)+
  labs(
    x="大腸菌株名(各n=4)",
    y="不活化速度定数k"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
```

Δuvr株の場合の不活化速度定数が、他の2条件に比べて有意に大きくなったのに対し、今回の実験条件においてはBW25113株とΔphr株の不活化速度定数の間には有意差は見られなかった。

## 考察

#### マルチヒットモデルのパラメータnについて

今回の実験では全班において、紫外線照射操作の全班では、線量と対数不活化率の間にはほぼ線形な関係が観測されており、大腸菌は構造が単純であるとしてn=1と仮定したモデルに良く当てはまっているといえる。

<!--# n>1の場合の曲線わからん。 -->

#### 不活化プロファイルの違いについて

今回の実験ではΔuvrの不活化速度定数が、他の2株に比べて大きくなった。これは、今回の実験における大腸菌の回復において、暗回復の影響が大きかったということを示唆する結果である。その一方で、BW25113株とΔphr株の不活化速度定数については、Δphr株の定数の平均値の方が大きかったものの、統計的に有意な差は見られなかった。これは、今回の実験においては明回復は不活化プロファイルに、あまり大きな影響は及ぼしていないということを意味している。

今回の実験では、採水から培養開始までの蛍光灯照明下での作業時間は、大きく見積もっても1時間ほどであったのに対し、蛍光灯照明が届きにくい環境での培養が24時間かけて行われている。BW、phr株の両株に関しては、この間に暗回復が起こっていたため、不活化速度定数が小さくなったのではないかと考えられる。

#### 不活化機構の研究のために必要な実験の提案

バイオインフォマティクス分野で活用が進む新技術の「ロングリード・シーケンサー」（ナノポアシーケンサー）を用いれば、紫外線照射によってチミン二量体が形成される様子が分子レベルで解析できると考えた。

具体的には、今回の実験のように一定時間紫外線を照射した後、培養と並行して大腸菌サンプルから核酸を抽出し、ナノポアシーケンサーによるロングリードシーケンシングを行う。前処理においては、DNA鎖を破壊しないような前処理の方法が求められる。その後、得られたサンプルをローングリード・シーケンシングにより解析する。波形データはDORADOなどの通常のベースコールソフトウェアで処理せずに、波形そのものを、UV非照射の菌株の配列データと比較するなどの工夫が必要となるだろう。同時に、ベースコールやアセンブリといったバイオインフォマティクス解析を行い、チミン二量体の発生場所の予測データと照らし合わせることで、「どこの遺伝子の損傷が不活化に関与しているのか」を知ることができると考えられる。

ただ、全ゲノム解析という実験手法の性質上、PCR法などと比べて定量性が犠牲となるため、「どこが変異しているか」を調べるだけの、定性的な研究に終わってしまうという懸念点もある。

#### 紫外線不活化に影響を与える因子・実務への提言

今回の実験条件においては、暗回復の影響が大きかった。暗回復は特に、光の入らない送水・配水管を通して水道水を送る必要のある上水道システムにおいて問題になると考えられる。

そこで、東京都水道局が浄水場だけでなく給水所や配水網の随所で塩素注入を行っているのと同様に、給水所や配水網にも紫外線消毒装置を装備することで、暗回復した病原微生物を再び不活化することができるのではないだろうか。

#### PFAS分解における紫外線処理の利用について

ウシオ電機が、紫外線を照射することにより水中にラジカルを発生させ、長鎖PFAS・PFOAを分解するという技術を開発していることを、昨年の1月にInterAquaという展示会に行った際に知った。PFAS・PFOA問題について、吸着後の活性炭の処理が問題とされている(現時点では、貯蔵か焼却以外に選択肢がない)中、先進的な技術として注目されているようだが、まだ実証実験段階であるとのことである。

この手法は、未だに決定的な解決策の見つからないPFASの分解技術として有望であるが、ラジカルを発生させるためには、波長172nmの光を発する「エキシマランプ」が必要になる。今回、消毒用に用いた紫外線の波長(254nm)よりも短波長の紫外線ランプということで、エキシマランプは浄水用のランプに比べて高価である。また、展示会でご説明を頂いたウシオ電機の方からは、「ウシオ電機は日本国内に工場を設けているため人件費が高く、中国製などの安い浄水用ランプと比べてランプの値段が高くなってしまう」という話も聞いた。そのため、環境浄化技術として実用化を目指す上では、コスト削減が鍵になると考えられる。

## 実験課題Eを通した考察

塩素処理と紫外線処理にはそれぞれ利点と欠点がある。塩素消毒は塩素注入が容易であること、効果が確実かつ残留塩素により消毒効果が持続するといった利点がある一方で、塩素が水中の溶存有機物と反応することによってトリハロメタンなどの消毒副生成物を生じるという欠点がある。紫外線消毒は消毒副生成物を生じないという利点があるものの、塩素消毒とは異なり消毒効果には残留性がない。また、懸濁物質が存在する場合は消毒効果が低下してしまうという欠点もある。

健康関連微生物の水循環システムにおける制御にあたっては、上水プロセスでの問題にとどまらず、より広い観点に立った施策展開が行われることが望まれる。例えば、上水道と下水道の行政上の連携が必要であると私は考える。水環境中に放出される健康関連微生物の多くは、下水処理場から処理水として放出されたものに由来する。そのため、浄水場での消毒の必要性を最低限に減らすためには浄水処理だけではなく、下水処理も視野に入れて考える必要がある。具体的には、上流に下水処理場、下流に浄水場が分布している水系においては、下水処理場の運転状況(BOD除去率、排水の微生物指標など)を下流の浄水場に共有し、互いの運転の最適化に役立てるなどの工夫が考えられる。

次に、病原微生物による感染リスクと消毒副生成物による発がんリスクのトレードオフに関しては、特にアメリカや日本、欧州などの先進国においては20世紀後半から、定量的なリスク評価に基づいた意思決定を重んじる考え方が学識経験者によって主張されてきたにもかかわらず、現在でもリスクの考え方は、市民には正しく理解されていないのが現状であると考えられる。上下水道以外の分野の具体例にはなるが、ワクチン接種問題やPFAS汚染問題など、生命に係るリスクが少しでもある場合には、近年のSNSによる意見の拡散の速さも相まって、定性的で感情的な議論に陥る場合が少なくない。

このような状況の中で、定量的なリスク評価に基づく政策議論が行われるためには、まず、上下水道とは公衆衛生のためのインフラであるという認識を市民・政治家に浸透させることが大事であろう。科学的に考えて、消毒副生成物による発がんリスクよりも、消毒を行わないことによる感染リスクの方が数桁レベルで大きいことは明らかである。また、欧州式の塩素低減型水道システムの導入も積極的に検討すべきであるものの、既存の設備のみでは対応ができないため、導入には相応の予算が必要となる。管路網更新や耐震化などが喫緊の課題とされている中で新技術を導入するには、水道事業そのものに関する市民の理解を深め、新技術導入の意義について合意を得ることがまず、最も重要になるのではないだろうか。

# 付録(レポートのソースコード)

本レポートの分析・執筆に用いたソースコードならびに、元データは以下から閲覧できます。

<https://github.com/nos-urbanenv/wtrwks_rpt>

# 参考文献
