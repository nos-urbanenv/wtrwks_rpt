---
title: "浄水処理実験 実験レポート"
author: "03250114 大隅伸明"
format: 
  #typst:
   # toc: true
  pdf:
    pdf-engine: lualatex
    documentclass: ltjsreport
    #fig-pos: 'h'
    #tbl-pos: 'h'
#    mainfont: "Hiragino Maru Gothic Pro"
    classoption: [10pt]
editor: visual
---

```{r util-read_packages}
#| include: false
#| echo: false
library(tidyverse)
library(gt)
library(gridExtra)

hiragino <- "Hiragino Maru Gothic Pro"
```

```{r util-make_csv_mirrors}
#| include: false
#| echo: false
# readxl packageの公式ドキュメントでは、EXCELファイルのミラーイメージをcsvとして保存することが推奨されている。
# ./data_rawディレクトリにあるxlsxなどの形式の入力ファイルを、使用目的ごとにcsvに分割してミラーとし、githubでの更新履歴追跡を容易にする。
# readxlのドキュメントで推奨されているそのままのコード。
cur_dir <- getwd()
rawdata_dir <- paste0(cur_dir, "/data_raw") #元データ格納先
output_dir <- paste0(cur_dir, "/data") #データ出力先
xlsx_path <- paste0(rawdata_dir, "/input.xlsx") #excelのパス

read_then_csv <- function(sheet, path, opt_dir){
  sheet_dat <- readxl::read_xlsx(sheet = sheet, path = path)
  csv_path <- paste0(opt_dir ,"/" ,sheet,".csv")
  write.csv(sheet_dat, file = csv_path, row.names = FALSE)
}

# 実験ノートから手入力したデータ
readxl::excel_sheets(xlsx_path) %>% 
  map(read_then_csv, path = xlsx_path, opt_dir = output_dir) 

# 機器分析の結果 絶対にいじらない。
# 今回はTOCのみ(※belsorpはbashで別に処理)
list.files(rawdata_dir, pattern = "TOC*", full.names = TRUE) %>% 
  set_names() %>%  #よくわからないがチュートリアルに従って入れた。
  map(~readxl::read_xlsx(.x)) %>% 
  imap(function(x, idx)
       write.csv(x, file=paste0(
         output_dir, "/",
         tools::file_path_sans_ext(basename(idx)),
         ".csv"),
         row.names = FALSE
         ))
```

# 本実験演習の目的

上水実験課題では以下の項目を扱い、浄水処理の物理化学的な原理について定性的・定量的な両面から理解を深めることを目的とする。

1.  凝集沈殿における最適条件の決定

2.  急速濾過における目詰まり状況の解析

3.  オゾンによる有機物分解

4.  活性炭の吸着特性の解析

5.  消毒

    1.  塩素消毒

    2.  紫外線消毒

# 課題A オゾンによる有機物分解

## 実験概要

### 実験原理

オゾン処理においては、オゾンの強力な酸化力によって高分子の難分解性有機物が酸化分解される。

水中のオゾンの

そこで本実験では、pHがオゾンによる有機物分解に与える影響を調べるため、酸性・中性・アルカリ性の3種類の緩衝溶液にメチレンブルーを一定量加え、オゾン通気を行った。一定時間ごとにオゾン通気中のフラスコから採水を行い、メチレンブルー濃度(2分毎)、TOC濃度、pH、オゾン濃度(最初と最後)の測定を行った。メチレンブルー濃度の測定に当たっては、吸光度法(665nm)を用いた。メチレンブルーは吸着性が高いことから、吸光度測定時には石英セルではなくプラスチックセルを使用し、こまめにMilli-Q水を測定することでセルに吸着していないかを確かめた。溶存オゾン濃度はHACH社の簡易キットを用いてインディゴ法で測定した。TOC濃度測定には島津製作所TOC-Vを使用した。

### 実験手順

実験の詳細な手順を以下に示す。

1.  予め分光光度計の電源を入れ、内蔵ランプの出力を安定させる

2.  試薬調整\
    以下の試薬・溶液を調整する。

-   pH2, pH7.2, pH12の緩衝溶液
    -   pH2:
    -   pH7.2:
    -   pH12:
-   メチレンブルー標準原液(1g/L)
    -   緩衝溶液にはこの標準原液を、500mLあたり25mL添加した。

3.  検量線の作成\
    結果の章で示すように、0mg/L\~20mg/Lの範囲で標準列を作成した上で、検量線が線形性を保つ範囲のデータを採用した。
4.  オゾン通気準備(2, 3と同時並行)\
    オゾン発生器を起動し、3\~5分間バイパスで湿気を追い出した。その後、Milli-Q水500mLに5分間通気し、溶存オゾン濃度を測定した。各条件での実験終了後も、同様にMilli-Q水に通気してオゾン濃度を測定することで、オゾン発生器から発生しているオゾン濃度が一定であるかどうかを確認した。
5.  オゾン処理\
    実験原水(緩衝溶液500mLにメチレンブルー標準原液25mLを添加)を反応器に入れ、オゾンを通気する。オゾン通気開始直前をt=0とし、2分ごとに採水する。
6.  水質分析\
    採水したサンプルについて、メチレンブルー濃度(全サンプル)、TOC濃度・pH・オゾン濃度(最初と最後のサンプル)を測定する。

## 結果

まず、メチレンブルー濃度算出に用いる検量線を作成した。各班の実測値を @tbl-ozn-calib に示す。

```{r tbl-ozn-calib}
#| echo: false
#| tbl-cap: "オゾン検量線の元データ"

# オゾンのデータ読み込み
ozn_calib <- read.csv("data/ozone_calib.csv")

# 検量線用の希釈列データの表組み
ozn_calib %>% 
  filter(班==3) %>% 
  arrange(メチレンブルー濃度.mg.L.) %>% 
  select(-c("班")) %>% 
  gt() %>% 
  cols_align(
    align="center",
    columns=everything()
  ) %>% 
  cols_label(メチレンブルー濃度.mg.L.="MB濃度(mg/L)",
             吸光度="665nm吸光度")
```

<!--# ここの表現もうちょっと洗練させたいなぁ。。 -->

上記のデータを用いて最小二乗法で検量線を作成したところ、今回採用した希釈段階の全域に渡ってデータは線形な変化であることを確認することができた。検量線モデルは、R言語の`lm`関数により、吸光度を目的変数、メチレンブルー濃度を説明変数とした線形回帰を行うことにより導出した（以下同様）。

```{r fig-ozn-calib, dev='jpeg'}
#| echo: false
#| warning: false
#| fig-cap: "メチレンブルー濃度の検量線"

# 検量線プロット
ozn_calib %>% 
  filter(班==3) %>% 
  ggplot(mapping = aes(x=メチレンブルー濃度.mg.L., y=吸光度))+
  geom_point()+
  geom_smooth(method="lm",color="black")+
  labs(
    #title="メチレンブルー濃度の検量線",
    x="メチレンブルー濃度(mg/L)",
    y="665nm吸光度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))
```

@fig-ozn-calib の検量線を用いて、各時刻でのメチレンブルー濃度を算出した。pH・オゾン濃度・TOC濃度の実測値と合わせ、 @tbl-ozone に結果を示す。

検量線法による濃度推定を行うに当たっては、ブランク試料を測定した際の吸光度を下回ったサンプルは「検出限界以下」として扱った。この点について気になり調査したが、一般的にはIUPAC発行の"Compemdium of Chemical Terminology"の記載に則り、 @eq-LOD-and-LOQ と @eq-LOQ に示したような定義が用いられるとのことである。($※ただし、a: ブランクの平均、\sigma: ブランクの標準偏差$)

<!--# ここ、出典がgolden bookとagilientのサイトの3つが必要！ -->

$$
LOD(Limit\ of\ Detection) = a + 3\sigma\\   
$$ {#eq-LOD-and-LOQ}

$$
LOQ(Limit\ of\ Quantification) = a + 6\sigma\\
$$ {#eq-LOQ}

しかしながら、今回の実験演習ではブランクの測定を1回しか行っていないため、ブランク試料の標準偏差を求めることができず、統計学的な検出限界ならびに定量限界を求められない。そこで今回はやむを得ず、1回だけ測定したブランク試料の吸光度を機器のノイズレベルとみなし、ブランク試料の吸光度を下回ったサンプルを定量限界を下回ったサンプルとして処理することにした。本レポートにおいて検量線法を用いている他の実験においても同様の処理を行った。（例： @tbl-ozone に示した計測結果の場合は、ブランクの吸光度は0.000だったため、吸光度の測定結果が負となったサンプルが「測定限界」として表記されている。）

```{r calc-MB-conc}
#| echo: false

#検量線を用いて濃度を算出する。吸光度測定時の希釈倍率も考慮。
# 回帰モデルの作成
lm_ozn_dat <- ozn_calib %>% 
  filter(班==3) 
lm_ozn <- lm(lm_ozn_dat$吸光度 ~ lm_ozn_dat$メチレンブルー濃度.mg.L.,
             model = TRUE)

# 推定用関数
# 解析コードの流れを邪魔しているので、.Rファイルとして分離する予定。
inverse_pred.calc <- function(y, alpha, beta){
  return((y - beta) / alpha)
}

inverse_pred <- function(y, lm_mod){
  alpha <- unname(lm_mod$coefficients[2])
  beta <- unname(lm_mod$coefficients[1])
  
  blank_y <- min(lm_mod$model[[1]])
  lower_lim <- inverse_pred.calc(y = min(lm_mod$model[[1]]),
                                  alpha = alpha,
                                  beta = beta)
  upper_lim <- inverse_pred.calc(y = max(lm_mod$model[[1]]),
                                  alpha = alpha,
                                  beta = beta)
  pred.val <- inverse_pred.calc(y = y,
                                alpha = alpha,
                                beta = beta)
  if(is.na(y)){
    return(tibble(MB_conc=NA, MB_info=NA))
  }
  #else if(pred.val < lower_lim){
  else if(y < blank_y){
    return(tibble(MB_conc=NA, MB_info="<LOD"))
  }
  else if(pred.val > upper_lim){
    return(tibble(MB_conc=pred.val, MB_info="外挿"))
  }
  else{
    return(tibble(MB_conc=pred.val, MB_info="fine"))
  }
}


# 実験データの読み込みと検量線モデル適用
ozone <- read.csv("data/ozone.csv")
ozone <- ozone %>% 
  mutate(ozn_mdlfit = map(吸光度, inverse_pred, lm_mod = lm_ozn)) %>% 
  unnest(ozn_mdlfit) %>% 
  mutate(MB_conc = MB_conc * 吸光度_希釈)
```

```{r calc-ozone-TOC}
#| echo: false

# TOCデータ読み込みと抽出
TOC_1_2 <- read.csv("data/TOC_ozone_1_2.csv", header = FALSE)
TOC_3_4 <- read.csv("data/TOC_ozone_3_4.csv", header = FALSE) %>% 
  filter(V4=="NPOC") %>% 
  select(c("V3", "V9")) %>% 
  `colnames<-`(c("TOC_vial","TOC_conc")) %>% 
  mutate_all(as.numeric) #%>% 
  #mutate(TOC_filename = "1_2")

# 実験ノートのデータと統合
ozone <- ozone %>% 
  left_join(TOC_3_4, by="TOC_vial")
```

```{r tbl-ozone}
#| echo: false
#| tbl-cap: "オゾン処理時の各水質指標の測定結果"

# 実験データの表組み
ozone %>%
  filter(班==3) %>% 
  select(-c("班","TOC_vial","TOC_filename")) %>% 
  group_by(条件) %>% 
  gt() %>% 
  text_transform(
    locations = cells_body(columns = starts_with("MB_"),
                           rows = MB_info == "<LOD"),
    fn = function(x) {x = "定量限界以下"}
  ) %>% 
  fmt_number(decimals = 1,
             columns = c("MB_conc", "TOC_conc")) %>% 
  tab_spanner(label = "メチレンブルー濃度測定",
              columns = c("吸光度","吸光度_希釈","MB_conc")) %>% 
  cols_hide(columns = c("MB_info")) %>% 
  cols_label(時間.分. = "時刻(分)",
             吸光度_希釈 = "希釈倍率",
             MB_conc = "濃度(mg/L)",
             O3_conc = "オゾン濃度(mg/L)",
             TOC_conc = "TOC濃度(mg/L)") %>% 
  cols_align(align = "center", columns = everything()) %>% 
  sub_missing(missing_text = "-")
```

酸性のt=0でのサンプルの吸光度の値が、t=2での値よりも小さくなってしまっている。酸性・中性・アルカリ性の各条件について、TOCの値は約15前後で一定しているため、メチレンブルー溶液の投入量を間違えた可能性は低い。従って、吸光度測定の時点で、希釈倍率を間違えるなどの手違いがあったと推測される。

メチレンブルー濃度の時間変化を図示すると @fig-MB-conc のようになった。

```{r fig-MB-conc, dev='jpeg'}
#| echo: false
#| warning: false
#| fig-cap: "メチレンブルー濃度の経時変化"

ozone %>% 
  filter(班==3) %>% 
  select(c("時間.分.","MB_conc","条件")) %>% 
  ggplot(mapping=aes(x=時間.分. , y=MB_conc, color=条件)) +
  geom_point() +
  geom_line(linetype = 3) +
  labs(
    x="時間(分)",
    y="メチレンブルー濃度(mg/L)"
  ) +
  theme_bw() +
  theme(text=element_text(family=hiragino))
```

## 考察

結果の章には自分たち(3班)のデータを示したが、

# 課題B 急速濾過における目詰まり状況と処理性能の解析

## 実験概要

### 実験原理

<!--# ここ教科書の出典入れないとだめ!! -->

急速濾過法はヨーロッパに比べて水需要が多い上、原水濁度が高いアメリカで発達したプロセスである。急速濾過池においては、硫酸アルミニウムなどを凝集剤としてフロックを形成させ、沈澱池で沈殿させた後、除去しきれなかった微細なフロックが、砂などの粒状濾材を用いて物理化学的に除去される。

本演習では、濾材に原水を通水して濁質を除去する「濾過」と、逆洗浄によって濁質を洗い流す「逆洗」という急速濾過法の2つのプロセスについてモデル実験を行う。原水としてカオリン懸濁液と三四郎池の水、濾材には砂・アンスラサイトを用い、濾過工程におけるろ過抵抗の測定を行う。ろ過抵抗は、濾過筒に接続されたマノメータにより深さごとの損失水頭を求めることで算出する。逆洗工程においては、濾材の下方から水道水を流し、様子を観察するとともに、逆洗水を一定時間ごとに採取してSS濃度を測定する。　また、濾材について、ふるい分けによる粒径決定、仮比重・真比重の測定を行う。

### 実験手順

実験手順の詳細を以下に示す。

#### 実験機器について

-   濾過筒の濾材構成

    -   A: 指定砂60cm

    -   B: 指定砂60cm

    -   C: アンスラサイト30cm(上部)⇨指定砂30cm(下部)

-   凝集剤：硫酸アルミニウム

#### 準備・凝集沈殿操作

1.  濾材の洗浄\
    水道水を用いて逆洗浄を行う。

2.  マノメータの点検\
    逆洗後、濾過筒に水を満たした状態でマノメータのバルブをすべて開く。水が流れていない状態では損失水頭は0なので、マノメータの高さは水平に揃うはずである。揃っていない場合は気泡が配管に残っている(=気泡による圧力水頭がマノメータの読みに影響を与えている)可能性があるため、マノメータ上部からゴム球で空気を送り込み、気泡を排除する。\
    その後、濾過筒下部の濾水流出バルブを開き、マノメータの水位が安定した後、マノメータの水位を記録する。この水位は「流出水位」に対応する。

3.  原水の作成・凝集沈殿操作\
    三四郎池の水を採取する。また、濃度が75mg/Lになるように水道水にカオリンを添加し、カオリン原水とする。前者には、実験Aで求めた最適凝集条件の通りに、後者には100mg/L凝集剤を投入し、2分程度、早めの回転数で急速撹拌する。その後、撹拌機の速度を弱め、緩速撹拌する。

4.  ポンプの流量調節\
    それぞれの濾過系統において用いるポンプの流量を、メスシリンダーを用いて流量を実測しながら、約650mL/minになるように調節する。調節後のポンプの流量を記録する。

#### 急速濾過・逆洗浄実験

1.  清水濾過実験\
    3系統それぞれの濾過筒について、水道水を通水し、単位ろ層厚さあたりの損失水頭を求める。

2.  急速濾過実験\
    まず、原水の濁度・温度を測定する。ポンプを稼働させて原水を通水し、15分間隔でマノメータの水位を記録する。また、30分間隔で原水・濾過水を採取し、濁度を測定する。マノメータの読みに注意し、目詰まりが起こるまで計測を継続する。

3.  逆洗浄実験(C筒のみ)\
    排水バルブ・マノメータバルブを閉じ、水道水により500L/hの流量で逆洗浄を用いる。また、逆洗浄開始時をt=0とし、適当な時間間隔ごとに逆洗排水を採取し、SSを測定する。逆洗終了時には、逆洗用バルブよりも、水道栓を先に閉めるように注意する。

## 結果

### 急速濾過

マノメータ水位の変化を @tbl-manometer に示す。

```{r tbl-manometer}
#| echo: false
#| tbl-cap: "マノメータ水位の変化"

# データ読み込み
manometer <- read.csv("data/manometer.csv") %>% 
  mutate(filter = paste0(filter,"筒")) 

# マノメータ水位データの表組み
manometer %>% 
  pivot_longer(cols = c(starts_with("time_"), "tapwtr"),
                 names_to = "sampling") %>% 
  pivot_wider(names_from = "manometer",
                values_from = "value") %>% 
  group_by(班, filter, sampling) %>% 
  drop_na() %>% 
  filter(班==3) %>% 
  group_by(filter) %>% 
  gt() %>% 
  cols_hide("班") %>% 
  cols_label(sampling="")
```

上記の実測値より、損失水頭を求めた結果を @tbl-lost-head に示す。

<!--# データが多いため図は考察セクションに配置するかも? -->

```{r tbl-lost-head}
#| echo: false

# 損失水頭の計算
manometer_head <- manometer %>% 
  pivot_longer(cols = starts_with("time_"),
               names_to = "time",
               names_prefix = "time_") %>% 
  filter(!is.na(value)) %>%
  mutate(head_loss = tapwtr - value) #%>% 
  
#  pivot_longer(cols = c(starts_with("time_"), "tapwtr"),
#               names_to = "sampling") #%>% 
#  pivot_wider(names_from = "manometer",
#              values_from = "value") %>% 
#  group_by(班, filter, sampling) %>% 
#  drop_na()
```

@tbl-lost-head の値について、横軸に単位濾層あたりの損失水頭、縦軸に濾層深さをとってプロットした結果を @fig-manometer に示す。

```{r fig-manometer}
#| echo: false
#| fig-cap: "マノメータの目詰まり状況"
```

次に、濁度の測定結果を @tbl-filt-turb に示す。また、濁度の除去率の経時変化を求め、 @fig-filt-turb に図示した。

```{r tbl-filt-turb}
#| echo: false
#| tbl-cap: "急速濾過実験における濁度の経時変化"


```

```{r fig-filt-turb}
#| echo: false
#| fig-cap: "濁度除去率の経時変化"

```

### 逆洗浄

逆洗時に採水を行い、SSを測定した結果を @tbl-reverse-SS に示す。

```{r tbl-reverse-SS}
#| echo: false
#| tbl-cap: "逆洗排水のSS濃度の経時変化"

# csv用意するのがめんどくさいので直接入力
reverse_SS <- tribble(
  ~time, ~bef_g, ~aft_g, ~amt_ml,
  1, 0.4036, 0.4116, 100,
  2, 0.4000, 0.4064, 100, 
  3, 0.4134, 0.4208, 100,
  4, 0.3999, 0.5724, 100,
  5, 0.4012, 0.4637, 100,
  6, 0.4069, 0.4402, 100,
  7, 0.4069, 0.4199, 100
) %>% 
  # SSの単位はmg/mL
  # 差(g)に1000掛けてmgに変換し、濾過量(公定法ではL)で割る
  mutate(SS = (aft_g - bef_g) * 1000 / (amt_ml / 1000))

reverse_SS %>% 
  gt() %>% 
  # 自班データに関しては整数表示で有効数字は問題なし。
  fmt_number(columns = "SS", decimals = 0) %>% 
  #見た目はなかなか悩ましい問題。
  cols_align(align = "center", columns = c(-"time")) %>% 
  cols_align(align = "left", columns = "time")
```

### ろ過筒の仕様測定

ふるい分けの結果を @tbl-sieve に示す。また、粒度加積曲線を @fig-sieve に示す。

```{r tbl-sieve}
#| echo: false
#| tbl-cap: "ふるい分けの結果"


```

```{r fig-sieve}
#| echo: false
#| tbl-cap: "指定砂・アンスラサイトの粒度加積曲線"


```

## 考察

# 課題C 活性炭による色度成分の吸着

## 実験概要

### 活性炭による色度成分吸着実験

活性炭とは、木質（ヤシ殻、おが屑や石炭など）を原料として、これらの原料を炭化および賦活処理によりつくられた多孔性の炭素質の物質で

<!--# ここに出典 -->

その大きな内部表面積や微小細孔により、水中の有機物等を吸着することができる。浄水処理においては、異臭味物質・農薬・微量有害物質・合成洗剤・色度成分・トリハロメタン前駆物質などの除去の目的で活性炭処理が行われている。

本実験演習では、色度成分としてメチレンブルーを溶解した溶液に活性炭を加えて回分実験を行う。一定時間毎に採水し、色度成分の濃度を測定することで、吸着速度について調べる。また、吸着が平衡に達した際の濃度データをプロットすることで、吸着等温線に関する理解を深める。

### 吸着等温線について

### Belsorpによる細孔分布解析

Belsorpの原理

本レポートではBELSORPにより出力される「生の吸着等温線データ」についても解析を試みる。データ取得に際しては今野さんにご協力頂いた。

## 結果

### 検量線の作成

まず、メチレンブルー濃度の推定用の検量線を作成した結果を示す。

複数の希釈列を作成し、665nm吸光度を測定し、全データで検量線を作成した結果を @tbl-abs-calib-1 ならびに @fig-abs-calib-1 に示す。 なお、私達3班は2日目の測定時に新しく検量線を作成していたが、4班は作成していなかったとのことなので、3種類の検量線データを記載した。また、この場合の各検量線の回帰式とR\^2値を @tbl-abs-models-1 に示した。

```{r tbl-abs-calib-1}
#| echo: false
#| tbl-cap: "各希釈列ごとの吸光度"

# データ読み込み
abs_calib <- read.csv("data/abs_calib.csv")

# 検量線データの表組み
abs_calib %>% 
  pivot_wider(names_from = c(group, day),
              names_sep = "班_",
              values_from = ABS) %>% 
  gt() %>% 
  cols_label(MB_conc = "メチレンブルー濃度(mg/L)") %>% 
  tab_spanner(columns = c(-"MB_conc"),
              label = "665nm吸光度") %>% 
  sub_missing(missing_text = "-")
```

```{r fig-abs-calib-1, dev='jpeg'}
#| echo: false
#| message: false
#| warning: false
#| fig-cap: "メチレンブルー濃度の検量線"



# 検量線可視化
abs_calib %>% 
  mutate(model = paste(group, "班-", day, "日目")) %>% 
  ggplot(aes(x=MB_conc, y=ABS)) +
  geom_point() +
  geom_smooth(method="lm",color="black")+
  labs(
    x="メチレンブルー濃度(mg/L)",
    y="665nm吸光度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  #stat_poly_eq(use_label(c("eq","R2")))+ #確認用。見にくいので非表示
  facet_wrap(vars(model))
```

```{r tbl-abs-models-1}
#| echo: false
#| tbl-cap: "検量線の回帰式とR^2値"

# 検量線モデル作成
# 参考:tidyr::nest()の公式リファレンス
abs_models_all <- abs_calib %>% 
  group_by(group, day) %>% 
  nest() %>% 
  mutate(model = paste0(group, "班-", day, "日目"),
         lm = map(data, function(df) lm(ABS~MB_conc, data=df))) %>% 
  ungroup() %>% 
  select(-c("group", "day"))

# 検量線の式の表組み
abs_models_all %>% 
  ungroup() %>% 
  mutate(rgrsn = map_chr(lm, 
                     function(lm_mod){
                       alpha <- format(unname(lm_mod$coefficients[2]),
                                       digits=3)
                       beta <- format(unname(lm_mod$coefficients[1]),
                                      digits=3)
                       R2 <- format(summary(lm_mod)$r.squared,
                                    digits=4)
                       
                       return(paste0("y = ",alpha,"x + ",beta,
                                     ", R^2 = ",R2))
                     })) %>% 
  select(c("model", "rgrsn")) %>% 
  gt() %>% 
  cols_label(model="検量線",
             rgrsn="回帰式とR^2値")
```

@tbl-abs-models に示した通り、R\^2値はどれも約0.99となっているものの、これはメチレンブルー濃度が20mg/Lの希釈列に引っ張られた結果であると考えられる。そのため、20mg/Lの希釈列を除いて再度検量線を作成した結果を @fig-abs-calib-2 、 @tbl-abs-models-2 に示す。 @fig-abs-calib-1 の検量線よりも正確に線形回帰できているため、この検量線を用いて濃度計算を行う。

```{r fig-abs-calib-2, dev='jpeg'}
#| echo: false
#| message: false
#| warning: false
#| fig-cap: "メチレンブルー濃度の検量線(改良版)"

# 検量線可視化
abs_calib %>% 
  filter(MB_conc < 20) %>% 
  mutate(model = paste(group, "班-", day, "日目")) %>% 
  ggplot(aes(x=MB_conc, y=ABS)) +
  geom_point() +
  geom_smooth(method="lm",color="black")+
  labs(
    x="メチレンブルー濃度(mg/L)",
    y="665nm吸光度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  #stat_poly_eq(use_label(c("eq","R2")))+ #確認用。見にくいので非表示
  facet_wrap(vars(model))
```

```{r tbl-abs-models-2}
#| echo: false
#| tbl-cap: "検量線の回帰式とR^2値(改良版)"

# 検量線モデル作成
abs_models <- abs_calib %>% 
  filter(MB_conc < 20) %>% 
  group_by(group, day) %>% 
  nest() %>% 
  mutate(model = paste0(group, "班-", day, "日目"),
         lm = map(data, function(df) lm(ABS~MB_conc, data=df))) %>% 
  ungroup() %>% 
  select(-c("group", "day","data"))

# 検量線の式の表組み
abs_models %>% 
  ungroup() %>% 
  mutate(rgrsn = map_chr(lm, 
                     function(lm_mod){
                       alpha <- format(unname(lm_mod$coefficients[2]),
                                       digits=3)
                       beta <- format(unname(lm_mod$coefficients[1]),
                                      digits=3)
                       R2 <- format(summary(lm_mod)$r.squared,
                                    digits=4)
                       
                       return(paste0("y = ",alpha,"x + ",beta,
                                     ", R^2 = ",R2))
                     })) %>% 
  select(c("model", "rgrsn")) %>% 
  gt() %>% 
  cols_label(model="検量線",
             rgrsn="回帰式とR^2値")
```

### メチレンブルー吸着実験

吸光度の経時変化を

```{r tbl-abs-raw}
#| echo: false
#| tbl-cap: "665nm吸光度の経時変化"

# データ読み込み
abs <- read.csv("data/abs.csv")
```

作成した検量線を用いて濃度を計算した結果を @tbl-abs に示す。なお、4班のデータについては、十分に希釈を行っておらず、検量線が外挿となってしまった場合がある。その場合は数値の横に\*をつけて区別した。また、濃度の経時変化を @fig-abs に図示した。

```{r calc-abs}
#| echo: false

abs_calc <- abs %>% 
  as_tibble() %>% 
  pivot_longer(cols = c(starts_with("ABS_"), starts_with("Dil_")),
               names_to = c("abs_dat_type","time"),
               names_pattern = "(.*)_(.*)",
               values_to = "abs_dat_value")%>% 
  pivot_wider(names_from = abs_dat_type,
              values_from = abs_dat_value)

# 検量線モデルの適用
abs_calc <- abs_calc %>% 
  mutate(day = case_when(group=="3" & time=="24hrs" ~ 2,
                         .default = 1)) %>% 
  #group_by(group, day) %>% 
  #summarise(crbn=unique(crbn),
  #          MB_init_conc = list(MB_init_conc),
  #          crbn_amt = list(crbn_amt),
  #         time=list(time),
  #          ABS=list(ABS),
  #          Dil=list(Dil),
  #          .groups = "drop") %>% 
  mutate(model = paste0(group,"班-",day,"日目")) %>% 
  left_join(abs_models, by="model") %>% #検量線モデルと照合
  #mutate(res=map2(ABS,lm,function(list,mod){
  #  map_dfr(list,\(x) inverse_pred(x, mod))
  #})) %>%
  #select(-c("group","day","model","data","lm")) %>% 
  #unnest(-crbn) %>% 
  #ungroup()
  rowwise() %>% 
  mutate(res = inverse_pred(ABS, lm)) %>% 
  ungroup() %>% 
  unpack(res) %>% 
  select(-model, -lm, -group, -day) %>% 
  mutate(MB_conc = MB_conc * Dil) %>% 
  select(-ABS, -Dil)  
```

```{r tbl-abs}
#| echo: false
#| tbl-cap: "メチレンブルー濃度(mg/L)の経時変化"

# 濃度の経時変化の表組み
abs_calc %>% 
  mutate(MB = case_when(
    MB_info == "fine" ~ as.character(round(MB_conc,0)),
    MB_info == "<LOD" ~ "検出限界",
    MB_info == "外挿" ~ paste0(round(MB_conc,0),"*"),
    .default = NA
  )) %>% 
  select(-MB_info,-MB_conc) %>% 
  pivot_wider(names_from = time,
              values_from = MB) %>%
  group_by(crbn, MB_init_conc) %>%
  gt() %>% 
  cols_label(crbn_amt="活性炭添加量(g)") %>% 
  tab_spanner(columns = c(ends_with("min"),"24hrs"),
              label = "メチレンブルー濃度(mg/L)") %>% 
  sub_missing(missing_text = "-")
```

```{r fig-abs, dev='jpeg'}
#| echo: false
#| fig-cap: "メチレンブルー濃度の経時変化"
#| warning: false

abs_calc %>% 
  mutate(time = case_when(
    str_detect(time,"min$") ~ as.numeric(str_extract(time,"\\d+")),
    .default = 1440
  )) %>% 
  mutate(MB_conc = case_when( 
    MB_info == "<LOD" ~ 0, #検出限界は0としてプロット
    .default = MB_conc
  )) %>% 
  filter(!is.na(MB_conc)) %>% 
  ggplot(aes(x=time,y=MB_conc,group=crbn_amt,color=crbn_amt))+
  geom_point()+
  geom_line(linetype = 2)+
  scale_color_gradient(high = "red", low = "darkblue")+
  #scale_color_viridis_c(option = "viridis", direction = -1)+
  labs(
    x="経過時間(分)",
    y="メチレンブルー濃度(mg/L)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn, MB_init_conc))
```

次に、活性炭への吸着量をy軸にとったグラフを @fig-abs-2 に示す。

<!--# このグラフ、縦軸の取り方間違ってる！活性炭1gごとにしないとだめ！ -->

```{r fig-abs-2, dev='jpeg'}
#| echo: false
#| fig-cap: "メチレンブルー吸着量の経時変化"
#| warning: false

# 吸着量を求めるため一旦wideにしてmutateで処理する
abs_calc %>% 
  mutate(MB_conc = case_when( 
    MB_info == "<LOD" ~ 0, #検出限界は0としてプロット
    .default = MB_conc
  )) %>% 
  select(-MB_info) %>% 
  pivot_wider(names_from = time,
              values_from = MB_conc) %>% 
  mutate(across(c(ends_with("min"),"24hrs"),
         ~ `0min` - .x)) %>% 
  pivot_longer(cols = c(ends_with("min"),"24hrs"),
               names_to = "time",
               values_to = "MB_abs_conc") %>% 
  mutate(time = case_when(
    str_detect(time,"min$") ~ as.numeric(str_extract(time,"\\d+")),
    .default = 1440
  )) %>% 
  filter(!is.na(MB_abs_conc)) %>% 
  ggplot(aes(x=time,y=MB_abs_conc,group=crbn_amt,color=crbn_amt))+
  geom_point()+
  geom_line(linetype = 2)+
  scale_color_gradient(high = "red", low = "darkblue")+
  labs(
    x="経過時間(分)",
    y="メチレンブルー吸着量(mg/L)"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(vars(crbn, MB_init_conc))
  
```

### Belsorpによる細孔分布解析

まず、それぞれの活性炭の等温吸着曲線は @fig-abs-isthm のようになった。

```{r calc-belsorp-data}
#| echo: false

# GLCのデータ読み込み
GLC_bel_lines <- readLines("data/GLC1203.txt") %>% 
  stringr::str_split('\t')
GLC_df <- GLC_bel_lines[37:83] %>% #現実的妥協（汗）
  unlist() %>% 
  matrix(ncol=6,byrow = TRUE) %>% 
  as.data.frame.array() %>% 
  select(-c("V1","V6")) %>% 
  `colnames<-`(c("Pe","P0","Vd","V")) %>% 
  mutate_all(as.numeric)
rm(GLC_bel_lines)

# GWのデータ読み込み
GW_bel_lines <- readLines("data/GW1203.txt") %>% 
  stringr::str_split('\t')
GW_df <- GW_bel_lines[37:74] %>% #現実的妥協（汗）
  unlist() %>% 
  matrix(ncol=6,byrow = TRUE) %>% 
  as.data.frame.array() %>% 
  select(-c("V1","V6")) %>% 
  `colnames<-`(c("Pe","P0","Vd","V")) %>% 
  mutate_all(as.numeric)
rm(GW_bel_lines)

# データ描画用のmanipulation
# t-plotに用いるde Boir式
de_Boer <- function(P, P0){
  return(354 * (-5 / log(P / P0)) ^ (1/3) / 100) #pm->nm
}

GLC_df <- GLC_df %>% 
  mutate(sample = "GLC",
         prsr = Pe / P0,
         t_nm = de_Boer(Pe, P0),
         BET = Pe / (V * (P0 - Pe)))
GW_df <- GW_df %>% 
  mutate(sample = "GW",
         prsr = Pe / P0,
         t_nm = de_Boer(Pe, P0),
         BET = Pe / (V * (P0 - Pe)))
```

```{r fig-abs-isthm, dev='jpeg'}
#| echo: false
#| warning: false
#| fig-cap: "2種の活性炭の吸着等温線"

isthm_plt <- rbind(GLC_df, GW_df) %>% 
  ggplot(mapping=aes(x=prsr, y=V, color=sample))+
  geom_point()+
  labs(
    x="相対圧 P/P0",
    y="吸着量" # 正確な定義を記入する必要あり！
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

isthm_plt
```

GW活性炭(浄水処理用)は、

一方で、GLC活性炭には、相対圧が1付近でも吸着量の立ち上がりが見られ、大きめの細孔も吸着作用に寄与していることが示唆される結果となった。

次に、@fig-t-plot に各活性炭のt-plotを示す。t-plotとは…

tの算出には @eq-de_Boer を用いた。

※ここに出典を入れないと駄目。

$$
t = 354(\frac{-5}{ln(P_e/P_0)})^{1/3}
$$ {#eq-de_Boer}

```{r fig-t-plot, dev='jpeg'}
#| echo: false
#| warning: false
#| fig-cap: "2種の活性炭のt-プロット"

tplt <- rbind(GLC_df, GW_df) %>% 
  ggplot(mapping = aes(x=t_nm,y=V,color=sample))+
  geom_point()+
  labs(
    x="t(nm)",
    y="吸着量? V"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
  
tplt
```

また、以下のようなBETプロットを描画することで、表面積を概算することができる。

BETプロットは @eq-BET で表され、直線

※ここにサイトなどで良いので出典を入れる。

$$
BET=P_0
$$ {#eq-BET}

```{r fig-BET-plt, dev='jpeg'}
#| echo: false
#| warning: false

BET_plt <- rbind(GLC_df, GW_df) %>% 
  ggplot(mapping=aes(x=prsr,y=BET,color=sample))+
  geom_point()+
  labs(
    title = "2種の活性炭のBET-プロット",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

GLC_BET_plt <- GLC_df %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  labs(
    title = "GLC活性炭のBET-プロット",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

GW_BET_plt <- GW_df %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  labs(
    title = "GW活性炭のBET-プロット",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

# grid.arrange(GLC_BET_plt, GW_BET_plt, nrow=1)
BET_plt
```

BETプロットが直線形になる範囲において、近似直線を最小二乗法で求めた。近似結果を @fig-BET-calc と @tbl-BET-calc に示す。

```{r fig-BET-calc, dev='jpeg'}
#| echo: false
#| warning: false
#| fig-cap: "BET法の近似直線導出"

GLC_BET_calc_plt <- GLC_df %>% 
  filter(prsr<0.10) %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  geom_smooth(method="lm",color="black")+
  labs(
    title = "GLC",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

GW_BET_calc_plt <- GW_df %>% 
  filter(prsr<0.15) %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  geom_smooth(method="lm",color="black")+
  labs(
    title = "GW",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

grid.arrange(GLC_BET_calc_plt, GW_BET_calc_plt, nrow=1)
```

```{r calc-BET-calc}
#| echo: false

# 線形回帰

# 質量あたり表面積の計算

```

```{r tbl-BET-calc}
#| echo: false
#| tbl-cap: "BETプロットの線形近似の結果"

# 線形回帰モデルの式とR^2値の表組み(検量線と同様)

```

@fig-BET-calc に示したBETプロットから、表面積の合計は ?? と求められた。

最後に、

## 考察

# 課題D 凝集沈殿における最適条件の決定

## 実験概要

概要をここに書く。

## 結果

まず、二種類の水試料について、凝集剤の濃度を変化させて凝集剤の最適添加量を求めた。実験結果を @tbl-flc-amt に示す。

なお、m-アルカリ度の測定にあたっては、滴定に用いる0.01mol/L硫酸を…

<!--# ファクター導出のところが、自分でやってないのでよくわからない。要説明。 -->

標定を行った結果、ファクターは (※ここに数値埋め込み) となった。

<!--# 三四郎原水の生データがおかしいので要修正。それ以外は班EXCELとも一致確認済み。 -->

```{r calc-ttr_fctr}
#| echo: false

# 滴定に用いた0.01M硫酸の濃度補正のためのファクター
ttr_amt <- 17.94 # 他班を取り込む場合はリストにするかも?
ttr_fctr <- 20 / ttr_amt 
```

```{r tbl-flc-amt}
#| echo: false
#| tbl-cap: "凝集剤添加量の決定"

# データ読み込み
flc_amt <- read.csv("data/flc_amt.csv")

# m-アルカリ度計算
# pH4.8に達するまでに必要な酸の量をCaCO3の質量として求める(1Lあたり)
# 前期は滴定量が100mL指定だったが今期は可変なので注意。

# CaCO3当量(mg/L)に換算する
#モル質量100(以下では100.9)とした時に班EXCELとの一致を確認済み。
flc_amt <- flc_amt %>%
  filter(班==3) %>% 
  mutate(mアルカリ度 = 
           # 硫酸の消費モル数：滴定量_ml / 1000 * 0.01(mol/L) * factor
           (滴定_前 - 滴定_後) / 1000 * 0.01 * ttr_fctr *
           # 100.09 * 1000を掛ければCaCO3当量(mg)が得られる
           100.09 * 1000 / 
           # 試料1LあたりのCaCO3当量を得るために、(試料量/1000)で割る
           (滴定試料量/1000)
         )

# 凝集剤投入量決定実験の表組み
flc_amt %>%
  filter(班==3) %>% 
  select(-c("班")) %>% 
  group_by(実験) %>% 
  gt() %>% 
  #アルカリ度は有効数字3桁。
  # カオリン75以外は小数点以下1桁でうまくいく。
  # カオリン75だけ別指定したいんだがやり方は不明。
  # 何なら有効数字の表記法として正式にどうすればよいのかわからん。。
  fmt_number(columns="mアルカリ度", decimals=1) %>% 
  cols_align(align = "center", columns = everything()) %>% 
  cols_move_to_end(columns = starts_with("滴定")) %>%
  tab_spanner(label = "滴定の生データ",
              columns = starts_with("滴定")) %>% 
  #tab_header(title="凝集剤添加量の決定") %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

濁度の除去性能を比較した結果、最適な凝集剤濃度は三四郎池の場合は??、カオリン原水の場合は??であるということがわかった。

<!--# 全班一緒ならmax()で数値埋め込み。そうでなければ表を作る。 -->

次に、上記で求めた最適量だけ凝集剤を添加した条件の下で、pHを酸性\~アルカリ性の数段階で変化させ、前後のpH変化ならびに、処理後の濁度・ゼータ電位・水温・m-アルカリ度を計測した結果を @tbl-flc-ph に示す。なお、pHがおおよそ5よりも小さい条件においてはm-アルカリ度の測定は行っていない。

<!--# m-アルカリ度を測定しないところに試料量のデータが入っている。空欄にしてNA一括処理を噛ましたいので要修正。 -->

```{r tbl-flc-ph}
#| echo: false
#| tbl-cap: "各pH条件下での反応の比較"

#ttr_fctrは当然、凝集剤添加量決定時と同じものを使用する。
flc_ph <- read.csv("data/flc_ph.csv") %>% 
  #filter(班==3) %>% 
  mutate(mアルカリ度 = 
           (滴定_前 - 滴定_後) / 1000 * 0.01 * ttr_fctr *
           100.09 * 1000 /
           (滴定試料量/1000)
         )

# 添加量決定の際と同じ処理にしよう。
flc_ph %>% 
  filter(班==3) %>% 
  select(-c("班")) %>% 
  group_by(試料) %>% 
  gt() %>% 
  # pH11のところが有効数字がおかしいので個別で指定する必要あり。
  fmt_number(columns="mアルカリ度", decimals=1) %>% 
  cols_align(align = "center", columns = everything()) %>% 
  cols_move_to_end(columns = starts_with("滴定")) %>%
  tab_spanner(label = "滴定の生データ",
              columns = starts_with("滴定")) %>% 
  #tab_header(title="各phでの反応の比較") %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

## 考察

理論上、アルカリ度の減少は以下のようになる。

```{r calc-alkaline_theory}
#| include: false
#| echo: false
# このセルはただの計算機代わり。
```

# 課題E 消毒

## 実験概要

2種類の消毒方法に関して実験を行う。

## 結果

各条件下でのコロニー数の計数結果を @tbl-colony に示す。

```{r util-read-colony}
#| echo: false
colony <- read.csv("data/colony.csv")
```

```{r tbl-colony}
#| echo: false
#| message: false
#| tbl-cap: "大腸菌コロニー数の計数結果"

# table formatting
colony %>% 
  filter(班==3) %>% 
  group_by(実験名,サンプル名,採水時刻,希釈倍率) %>%
  mutate(コロニー数=paste(コロニー数,collapse = "/")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  mutate(コロニー数=paste0(
    "\\textbf{",コロニー数,"}","(×$10^",希釈倍率,"$)"
    ),
    コロニー数=paste0(コロニー数, collapse=", ")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  gt() %>% 
  #tab_header(title="大腸菌コロニー数の計数結果") %>% 
  fmt_passthrough(
    columns = コロニー数,
    escape=FALSE
  ) %>% 
  cols_align(align="center", columns=c("コロニー数","採水時刻")) %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

## 考察

# 付録 他班のデータ

考察において他班のデータを参照したため、全班の生データ比較が可能なよう、以下に全班のデータを示す。

```{r}

```
