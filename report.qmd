---
title: "浄水処理実験 実験レポート"
author: "03250114 大隅伸明"
format: 
  #typst:
   # toc: true
  pdf:
    pdf-engine: lualatex
    documentclass: ltjsarticle
#    mainfont: "Hiragino Maru Gothic Pro"
    classoption: [10pt]
editor: visual
---

```{r read_packages}
#| include: false
#| echo: false
library(tidyverse)
library(gt)
library(gridExtra)

hiragino <- "Hiragino Maru Gothic Pro"
```

```{r make_csv_mirrors}
# readxl packageの公式ドキュメントでは、EXCELファイルのミラーイメージをcsvとして保存することが推奨されている。
# 今回も、

#まず
```

<!--# ここに表紙用のraw latexコード -->

## 目的

上水実験課題では以下の項目を扱い、浄水処理の物理化学的な原理について定性的・定量的な両面から理解を深めることを目的とする。

1.  凝集沈殿における最適条件の決定

2.  急速濾過における目詰まり状況の解析

3.  オゾンによる有機物分解

4.  活性炭の吸着特性の解析

5.  消毒

    1.  塩素消毒

    2.  紫外線消毒

## 課題A オゾンによる有機物分解

### 実験概要

オゾン処理は主に高度処理で用いられ、

### 結果

```{r read_ozone_data}
#| echo: false
#| message: false
ozone <- read.csv("data/ozone.csv")
ozn_calib <- read.csv("data/ozone_calib.csv")
```

まず、メチレンブルー濃度算出に用いる検量線を作成した。各班の実測値は以下の通り。

```{r ozn_calib_calc}
#| echo: false

# 検量線の元データの表
ozn_clb_tbl <- ozn_calib %>% 
  arrange(班,メチレンブルー濃度.mg.L.) %>% 
  mutate(班=paste0(班,"班")) %>% 
  pivot_wider(names_from=班,values_from=吸光度) %>% 
  gt() %>% 
  tab_spanner(
    label="665nm吸光度",
    columns=ends_with("班")
  ) %>% 
  cols_align(
    align="center",
    columns=everything()
  ) %>% 
  cols_label(メチレンブルー濃度.mg.L.="MB濃度(mg/L)")

# 回帰式を計算


# 生データを表示
```

<!--# ここの表現もうちょっと洗練させたいなぁ。。 -->

上記のデータを用いて最小二乗法で検量線を作成したところ、今回採用した希釈段階の全域に渡ってデータは線形な変化であることを確認することができた。

```{r ozn_calib_plot, dev='jpeg'}
#| echo: false

# 検量線プロット
ozn_clb_plt <- ozn_calib %>% 
  ggplot(mapping = aes(x=メチレンブルー濃度.mg.L., y=吸光度))+
  geom_point()+
  geom_smooth(method="lm",color="black")+
  labs(
    title="メチレンブルー濃度の検量線",
    x="メチレンブルー濃度(mg/L)",
    y="665nm吸光度"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino),
        plot.title=element_text(hjust = 0.5))+
  facet_wrap(~班)

# 検量線を表示
ozn_clb_plt
```

上記の検量線を用いて、各時刻でのメチレンブルー濃度の変化を導出した。pH・オゾン濃度・TOC濃度の実測値と合わせ、以下に結果を示す。

<!--# ここの部分の計算は完全に嘘！修正してから出す！(このコメントは修正したら消す) -->

```{r MB_conc_calc}
#| echo: false
#検量線を用いて濃度を算出する。吸光度測定時の希釈倍率も考慮。
#今のところ、数値が出ることを確認するための嘘の式しか入っていない。
ozone <- ozone %>% 
  mutate(メチレンブルー濃度=1,
         TOC濃度 = NA)

#表示
ozone %>%
  select(-c("TOC_vial","TOC_filename")) %>% 
  group_by(班,条件) %>% 
  gt() %>% 
  cols_align(align = "center", columns = everything())
```

上記の検量線を用いてメチレンブルー濃度を計算し、時間変化を図示すると以下のようになった。

```{r MB_conc_plt, dev='jpeg'}
#| echo: false
ozone %>% select("時間.分.","メチレンブルー濃度","班") %>% 
  ggplot(mapping=aes(x=時間.分. ,y=メチレンブルー濃度)) +
  geom_point() +
  labs(
    title="メチレンブルー濃度の経時変化",
    x="時間(分)",
    y="メチレンブルー濃度(mg/L)"
  ) +
  theme_bw() +
  theme(text=element_text(family=hiragino)) +
  facet_wrap(~班)
```

### 考察

## 課題B 急速濾過における目詰まり状況と処理性能の解析

### 実験概要

### 結果

マノメータ水位は以下のように変化した。

```{r read_manometer_data}
# さすがにここはcsv入力しないときつそう。

```

逆洗時に採水を行い、SSを測定すると以下のようになった。

```{r reverse_}
# csv用意するのがめんどくさいので直接入力
reverse_SS <- tribble(
  ~time, ~bef_g, ~aft_g, ~amt_ml,
  1, 0.4036, 0.4116, 100,
  2, 0.4000, 0.4064, 100, 
  3, 0.4134, 0.4208, 100,
  4, 0.3999, 0.5724, 100,
  5, 0.4012, 0.4637, 100,
  6, 0.4069, 0.4402, 100,
  7, 0.4069, 0.4199, 100
) %>% 
  # SSの単位はmg/mL
  # 差(g)に1000掛けてmgに変換し、濾過量(公定法ではL)で割る
  mutate(SS = (aft_g - bef_g) * 1000 / (amt_ml / 1000))

reverse_SS %>% 
  gt() %>% 
  # 自班データに関しては整数表示で有効数字は問題なし。
  fmt_number(columns = "SS", decimals = 0) %>% 
  #見た目はなかなか悩ましい問題。
  cols_align(align = "center", columns = c(-"time")) %>% 
  cols_align(align = "left", columns = "time")
```

### 考察

マノメータの

## 課題C 活性炭による色度成分の吸着

### 実験概要

BELSORP miniによる解析

### 結果

また、BELSORP miniにより活性炭の細孔分布について解析した結果を示す。BELSORP miniの計測結果は、指定したディレクトリに"GLC1203.DAT"のようなファイル名のテキストファイルとして保存されている。以下では、そのファイルから取り出した、圧力と体積の実測データを使用して解析を行う。

まず以下にそれぞれの活性炭の等温吸着曲線を示す。

```{bash convert_DAT_files}
# RのreadLines()で読み込みがうまくいかなかったのでシェルで変換。
iconv -f CP932 -t utf-8 data_raw/GLC1203.DAT > data/GLC1203.txt
iconv -f CP932 -t utf-8 data_raw/GW1203.DAT > data/GW1203.txt
```

```{r read_belsorp_data}
#| echo: false

# GLCのデータ読み込み
GLC_bel_lines <- readLines("GLC1203.txt") %>% 
  stringr::str_split('\t')
GLC_df <- GLC_bel_lines[37:83] %>% #現実的妥協（汗）
  unlist() %>% 
  matrix(ncol=6,byrow = TRUE) %>% 
  as.data.frame.array() %>% 
  select(-c("V1","V6")) %>% 
  `colnames<-`(c("Pe","P0","Vd","V")) %>% 
  mutate_all(as.numeric)
rm(GLC_bel_lines)

# GWのデータ読み込み
GW_bel_lines <- readLines("GW1203.txt") %>% 
  stringr::str_split('\t')
GW_df <- GW_bel_lines[37:74] %>% #現実的妥協（汗）
  unlist() %>% 
  matrix(ncol=6,byrow = TRUE) %>% 
  as.data.frame.array() %>% 
  select(-c("V1","V6")) %>% 
  `colnames<-`(c("Pe","P0","Vd","V")) %>% 
  mutate_all(as.numeric)
rm(GW_bel_lines)

# データ描画用のmanipulation
# t-plotに用いるde Boir式
de_Boer <- function(P, P0){
  return(354 * (-5 / log(P / P0)) ^ (1/3) / 100) #pm->nm
}

GLC_df <- GLC_df %>% 
  mutate(prsr = Pe / P0,
         t_nm = de_Boer(Pe, P0),
         BET = Pe / (V * (P0 - Pe)))
GW_df <- GW_df %>% 
  mutate(prsr = Pe / P0,
         t_nm = de_Boer(Pe, P0),
         BET = Pe / (V * (P0 - Pe)))
```

```{r abs_isthm_plt, dev='jpeg'}
GLC_isthm_plt <- GLC_df %>% 
  ggplot(mapping=aes(x=prsr, y=V))+
  geom_point()+
  labs(
    title = "GLC活性炭の等温吸着曲線",
    x="相対圧",
    y="吸着量"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

GW_isthm_plt <- GW_df %>% 
  ggplot(mapping=aes(x=prsr, y=V))+
  geom_point()+
  labs(
    title = "GW活性炭の等温吸着曲線",
    x="相対圧",
    y="吸着量"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

grid.arrange(GLC_isthm_plt,GW_isthm_plt, nrow=1)
```

GW活性炭(浄水処理用)は、

一方で、GLC活性炭には、相対圧が1付近でも吸着量の立ち上がりが見られ、大きめの細孔も吸着作用に寄与していることが示唆される結果となった。

次に、t-plotを示す。t-plotとは…

tの算出には以下の式を用いた。

※ここに出典を入れないと駄目。

$$
t = 354(\frac{-5}{ln(P_e/P_0)})^{1/3}
$$ {#eq-de_Boer}

```{r t_plot, dev='jpeg'}
#| echo: false
GLC_tplt <- GLC_df %>% 
  ggplot(mapping = aes(x=t_nm,y=V))+
  geom_point()+
  labs(
    title = "GLC活性炭のt-プロット",
    x="t(nm)",
    y="吸着量? V"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))
  
GW_tplt <- GW_df %>% 
  ggplot(mapping = aes(x=t_nm,y=V))+
  geom_point()+
  labs(
    title = "GW活性炭のt-プロット",
    x="t(nm)",
    y="吸着量? V"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

grid.arrange(GLC_tplt, GW_tplt, nrow=1)
```

また、以下のようなBETプロットを描画することで、表面積を概算することができる。

BETプロットとは以下の式で表され、直線

※ここにサイトなどで良いので出典を入れる。

$$
BET=P_0
$$

```{r BET_plt, dev='jpeg'}
GLC_BET_plt <- GLC_df %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  labs(
    title = "GLC活性炭のBET-プロット",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

GW_BET_plt <- GW_df %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  labs(
    title = "GW活性炭のBET-プロット",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

grid.arrange(GLC_BET_plt, GW_BET_plt, nrow=1)
```

BETプロットが直線形になる範囲において、近似曲線を最小二乗法で求めると以下のようになった。

```{r BET_calc, dev='jpeg'}
GLC_BET_calc_plt <- GLC_df %>% 
  filter(prsr<0.10) %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  geom_smooth(method="lm",color="black")+
  labs(
    title = "GLC活性炭のBET-プロット(直線近似)",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

GW_BET_calc_plt <- GW_df %>% 
  filter(prsr<0.15) %>% 
  ggplot(mapping=aes(x=prsr,y=BET))+
  geom_point()+
  geom_smooth(method="lm",color="black")+
  labs(
    title = "GW活性炭のBET-プロット(直線近似)",
    x="相対圧",
    y="??"
  )+
  theme_bw()+
  theme(text=element_text(family=hiragino))

grid.arrange(GLC_BET_calc_plt, GW_BET_calc_plt, nrow=1)
```

### 考察

## 課題D 凝集沈殿における最適条件の決定

### 実験概要

概要をここに書く。

### 結果

まず、二種類の水試料について、凝集剤の濃度を変化させて凝集剤の最適添加量を求めた。実験結果は以下のようになった。

なお、m-アルカリ度の測定にあたっては、滴定に用いる0.01mol/L硫酸を…

<!--# ファクター導出のところが、自分でやってないのでよくわからない。要説明。 -->

標定を行った結果、ファクターは (※ここに数値埋め込み) となった。

<!--# 三四郎原水の生データがおかしいので要修正。それ以外は班EXCELとも一致確認済み。 -->

```{r ttr_fctr_calc}
#| echo: false

# 滴定に用いた0.01M硫酸の濃度補正のためのファクター
ttr_amt <- 17.94 # 他班を取り込む場合はリストにするかも?
ttr_fctr <- 20 / ttr_amt 
```

```{r flc_amt_tbl}
#| echo: false
# あとで消す(データ読み込み)
flc_amt <- read.csv("data/flc_amt.csv")

# m-アルカリ度計算
# pH4.8に達するまでに必要な酸の量をCaCO3の質量として求める(1Lあたり)
# 前期は滴定量が100mL指定だったが今期は可変なので注意。

# CaCO3当量(mg/L)に換算する
# 硫酸の消費モル数：滴定量_ml / 1000 * 0.01(mol/L) * factor
# 100.09 * 1000を掛ければCaCO3当量(mg)が得られる
# 試料1LあたりのCaCO3当量を得るために、(試料量/1000)で割る
flc_amt <- flc_amt %>%
  mutate(mアルカリ度 = 
           (滴定_前 - 滴定_後) / 1000 * 0.01 * ttr_fctr *
           100.09 * 1000 /
           (滴定試料量/1000)
         ) %>% #モル質量100とした時に班EXCELとの一致を確認済み。
  #group_by(班,実験) %>% 
  group_by(実験) #%>% 

# 表の作成

ttr_cols <- c("滴定_前","滴定_後","滴定試料量") #滴定生データの列

flc_amt %>%
  gt() %>% 
  #アルカリ度は有効数字3桁。
  # カオリン75以外は小数点以下1桁でうまくいく。
  # カオリン75だけ別指定したいんだがやり方は不明。
  # 何なら有効数字の表記法として正式にどうすればよいのかわからん。。
  fmt_number(columns="mアルカリ度", decimals=1) %>% 
  cols_align(align = "center", columns = everything()) %>% 
  cols_move_to_end(columns = ttr_cols) %>%
  tab_spanner(label = "滴定の生データ",columns = ttr_cols) %>% 
  tab_header(title="凝集剤添加量の決定") %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

濁度の除去性能を比較した結果、最適な凝集剤濃度は三四郎池の場合は??、カオリン原水の場合は??であるということがわかった。

<!--# 全班一緒ならmax()で数値埋め込み。そうでなければ表を作る。 -->

次に、上記で求めた最適量だけ凝集剤を添加した条件の下で、pHを酸性\~アルカリ性の数段階で変化させ、前後のpH変化ならびに、処理後の濁度・ゼータ電位・水温・m-アルカリ度を計測した結果は以下のようになった。なお、pHがおおよそ5よりも小さい条件においてはm-アルカリ度の測定は行っていない。

<!--# m-アルカリ度を測定しないところに試料量のデータが入っている。空欄にしてNA一括処理を噛ましたいので要修正。 -->

```{r flc_ph_tbl}
#| echo: false
#ttr_fctrは当然、凝集剤添加量決定時と同じものを使用する。
flc_ph <- read.csv("data/flc_ph.csv") %>% 
  mutate(mアルカリ度 = 
           (滴定_前 - 滴定_後) / 1000 * 0.01 * ttr_fctr *
           100.09 * 1000 /
           (滴定試料量/1000)
         )

# 添加量決定の際と同じ処理にしよう。
flc_ph %>% 
  group_by(試料) %>% 
  gt() %>% 
  # pH11のところが有効数字がおかしいので個別で指定する必要あり。
  fmt_number(columns="mアルカリ度", decimals=1) %>% 
  cols_align(align = "center", columns = everything()) %>% 
  cols_move_to_end(columns = ttr_cols) %>%
  tab_spanner(label = "滴定の生データ",columns = ttr_cols) %>% 
  tab_header(title="各phでの反応の比較") %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

### 考察

理論上、アルカリ度の減少は以下のようになる。

```{r alkaline_theory_calc}
#| include: false
#| echo: false
# このセルはただの計算機代わり。
```

## 課題E 消毒

### 実験概要

2種類の消毒方法に関して実験を行う。

### 結果

```{r read_colony_data}
colony <- read.csv("data/colony.csv")
```

```{r conony_table}
#| echo: false
#| message: false

# table formatting
colony %>% 
  group_by(班,実験名,サンプル名,採水時刻,希釈倍率) %>%
  mutate(コロニー数=paste(コロニー数,collapse = "/")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  mutate(コロニー数=paste0(
    "\\textbf{",コロニー数,"}","(×$10^",希釈倍率,"$)"
    ),
    コロニー数=paste0(コロニー数, collapse=", ")) %>% 
  summarise(コロニー数=unique(コロニー数)) %>% 
  gt() %>% 
  tab_header(title="大腸菌コロニー数の計数結果") %>% 
  fmt_passthrough(
    columns = コロニー数,
    escape=FALSE
  ) %>% 
  cols_align(align="center", columns=c("コロニー数","採水時刻")) %>% 
  tab_options(
    latex.use_longtable = TRUE
  )
```

### 考察
