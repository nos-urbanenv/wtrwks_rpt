---
title: "探索的因子分析 レポート課題"
author: "工学部都市工学科3年 大隅伸明(03250114)"
format: html
editor: visual
---

```{r include=FALSE}
#| message: false
#| echo: false
library(nFactors)
library(ggplot2)
library(tidyverse)
library(GPArotation)
library(MVN)
library(EFAtools)
library(pander)
library(knitr)
```

```{r}
#| echo: false
#データ読み込み
attitudes <- read.csv("attitudes_dat.csv")
#データ項目読み込み
questions <- readxl::read_xlsx("dat_vars.xlsx")
```

## 分析の前準備

### 項目どうしの相関の確認

まず初めに、各項目ごとの相関行列を作成し、corrplotパッケージを用いて可視化を行ってみる。

（参考1: <https://bookdown.org/sbtseiji/jamovi_complete_guide/sec-factor-efa.html> 参考2：<https://statorials.org/ja/r-の相関行列%2f>）

```{r}
#| echo: false
#| message: false
#相関行列を作成し、corrplotパッケージで可視化してみる
#参考：https://bookdown.org/sbtseiji/jamovi_complete_guide/sec-factor-efa.html
#参考2：https://statorials.org/ja/r-の相関行列%2f
library(corrplot)
corrplot(cor(attitudes))
```

上図から、互いに相関の高い項目群が存在することが推察される。以下では、それらの項目群に共通する因子を推定することが目標である。

### 多変量正規性の確認

```{r}
#| echo: false
mvn_test_rslt <- mvn(data = scale(attitudes), mvnTest = "hz")
pander(mvn_test_rslt$multivariateNormality)
```

探索的因子分析の前に変量正規分布検定を行い、多変量正規性の仮定が満たされていることを確認する。今回はp値は0となっているため、仮定を満たしているものとして分析を開始する。

## 因子数の決定

次に複数の方法を用いて因子数を推定する。

### スクリープロット・平行分析

```{r}
#| echo: false
#相関行列の固有値の計算
eigenvals<-eigen(cor(attitudes))
#平行分析
parallelAnalysis <- parallel(subject=nrow(attitudes),var=ncol(attitudes), rep=500,cent=.05)

#データを処理＋スクリープロット
data.frame("Component"=1:length(eigenvals$values),
              "Actual data" = eigenvals$values,
              "Simulated data"=parallelAnalysis$eigen$qevpea) %>% 
  gather(key="Type",value="Eigenvalue", -c("Component")) %>% 
  ggplot() + 
  geom_line(aes(x=Component, y=Eigenvalue,color=Type), linewidth=0.7)+
  geom_point(aes(x=Component, y=Eigenvalue,color=Type, shape=Type), size=2) +
  theme_bw(base_size = 14) +
  ggtitle("Scree plot")+geom_hline(yintercept = 1, color="red", linetype="dashed")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

スクリープロットの結果からは因子数は7個であると予測される。また、平行分析との交点を基準にすれば因子数は6個となる。

### カイザー基準

```{r}
#| message: false
print(round(eigenvals$values,digits=3))
```

1以上の固有値は8個存在する。つまり、因子数は8個と予測される。

## 因子抽出

### モデル1

因子数7、最尤法、回転はpromax法で推定を行うと以下のような結果となった。クロスローディングが起こったため、8個の観測変数を逐次的に除外した。なお、EFA関数のtypeオプションは"psych"を指定した。

```{r}
#| message: false
#| echo: false
attitudes_2 <- attitudes %>% select(-c("ICAR4","IHS28","ICAR8","IPTNM19","IHS25","IHS26","IHS27","IHS22"))
efa_ml_rslt <- EFA(
  x = attitudes_2,
  n_factors = 7,
  method = "ML",
  rotation = "promax",
  type = "psych"
)

#可視化のために整形する
rslt_1 <- efa_ml_rslt$rot_loadings %>% 
  unclass() %>% 
  as.data.frame() %>% 
  round(digits=2) 
rslt_1$question <- rownames(rslt_1)
rslt_1 <- rslt_1 %>% left_join(questions,by="question") %>% 
  mutate(across(where(is.numeric),~ifelse(.x<0.3,"",.x))) %>% 
  relocate(question,.before=everything())
kable(rslt_1,caption="因子負荷量")
kable(efa_ml_rslt$vars_accounted,caption = "各因子ごとの統計量")
kable(efa_ml_rslt$Phi,caption = "各因子の相関")
```

```{r}
efa_ml_rslt$fit_indices$p_chi
```

各因子に目立った相関はなく、モデルとしての信頼性は高いと考えられる。また、χ2乗検定のp値も小さく、有意なモデルであるといえる。

私は各因子を以下のように解釈した。

-   F3: 徒歩・自転車選好

-   F1: 趣味・生きがいとしての自動車選好（運転することそのものを好む）

-   F2: 居住環境における快適性重視傾向

-   F5: 居住環境における利便性重視傾向（快適性が犠牲になってもよい）

-   F4: 移動手段としての自動車選好（自動車の利便性を好む）

-   F6: 公共交通選好（ただし、ICAR3に影響を及ぼしていることに注意）

-   F7: 公共交通忌避

### モデル２

因子数7で、今度は主因子法で推定を行った。回転はPromax法を用い、クロスローディングが起こったため9個の観測変数を逐次的に除外した。

```{r}
#| message: false
#| echo: false
attitudes_3 <- attitudes %>% select(-c("ICAR5","ICAR6","IHS20","IHS27","IHS30","IHS23","IPTNM18","IPTNM9","IPTNM19"))
#主因子法
efa_pa_rslt <- EFA(
  x = attitudes_3,            
  n_factors = 7,
  method="PAF",
  rotation = "promax" 
)


#可視化のために整形する
rslt_2 <- efa_pa_rslt$rot_loadings %>% 
  unclass() %>% 
  as.data.frame() %>% 
  round(digits=2) 
rslt_2 $question <- rownames(rslt_2)
rslt_2 <- rslt_2 %>% left_join(questions,by="question") %>% 
  mutate(across(where(is.numeric),~ifelse(.x<0.3,"",.x))) %>% 
  relocate(question,.before=everything())
kable(rslt_2,caption="モデル2の因子負荷量")
kable(efa_pa_rslt$vars_accounted,caption = "各因子ごとの統計量")
kable(efa_pa_rslt$Phi,caption = "各因子の相関")
```

私自身の分析者としての解釈は以下の通り。

-   F1: 自動車選好（運転することそのもの・自動車の利便性をともに高く評価）

-   F2: 居住環境における利便性重視傾向（快適性が犠牲になってもよい）

-   F4: 居住環境における快適性重視傾向（利便性が犠牲になってもよい）

-   F3: 公共交通選好

-   F5: 公共交通忌避

-   F6: 徒歩・自転車選好

-   F7: 環境志向（環境問題への意識が高い）

### モデル３

因子数6、最尤法で推定を行った。回転はPromax法を採用した。5個の観測変数を逐次的に除外した。

```{r}
#| message: false
#| echo: false
attitudes_4 <- attitudes %>% select(-c("IPTNM17","IHS30","IHS20","IHS23","IHS27"))
efa_ml_rslt_2 <- EFA(
  x = attitudes_4,
  n_factors = 6,
  method = "ML",
  rotation = "promax",
  type = "psych"
)

#可視化のために整形する
rslt_3 <- efa_ml_rslt_2$rot_loadings %>% 
  unclass() %>% 
  as.data.frame() %>% 
  round(digits=2) 
rslt_3$question <- rownames(rslt_3)
rslt_3 <- rslt_3 %>% left_join(questions,by="question") %>% 
  mutate(across(where(is.numeric),~ifelse(.x<0.3,"",.x))) %>% 
  relocate(question,.before=everything())
kable(rslt_3,caption="モデル3の因子負荷量")
kable(efa_ml_rslt_2$vars_accounted,caption = "各因子ごとの統計量")
kable(efa_ml_rslt_2$Phi,caption = "各因子の相関")
```

```{r}
efa_ml_rslt_2$fit_indices$p_chi
```

こちらも指標間の相関、p値ともに問題なく、有意なモデルであるといえる。

私自身の分析者としての解釈は以下の通り。

-   F2: 居住環境における利便性重視傾向（快適性が犠牲になってもよい）

-   F1: 自動車選好1（自動車に乗ること自体や、それによりもたらされる自由を好む）

-   F5: 自動車選好2（公共交通を嫌い、安心感を求めて車に乗る）

-   F4: 居住環境における快適性重視傾向（利便性が犠牲になってもよい）

-   F6: 公共交通選好

-   F3: 徒歩・自転車選好

## 最適なモデルの選択

以上に挙げた3つのモデルは、適合度指標等の観点から見ればどれも有意であるといえるが、私は3つ目のモデルが最も優れていると考える。

まず、モデル1とモデル2は推定の際、クロスローディングを防ぐために多くの観測変数を除外してしまっているという問題がある。さらに、モデル1は因子F6の解釈に若干問題がある。F6は主に公共交通志向の観測変数に影響を与えているが、"ICAR3":「環境に配慮するには、車の運転をやめるより、電気自動車などに変えた方がいいと思う」にも影響を与えている。この選択肢は自動車選好的な要素を含んでいる。そのため、因子F6は公共交通選好・自動車選好両方の要素を併せ持ってしまっており、その解釈が困難である。また、モデル2では「環境志向」という他の2つのモデルでは抽出されていない因子を抽出することができているものの、観測変数を30個中9個も除外してしまっているため、モデルの説明力がやや弱くなってしまっていると考えられる。

それに対して、モデル3は推定段階で除外した観測変数の数が5個に抑えられている上、因子の解釈も明確である。また、因子分析の結果のうち、F1とF5（居住環境における利便性vs快適性）、F2とF4（自動車選好の異なる理由）のように、対として考えられる指標が存在することで、このモデルは有用な分析の枠組みを提供していると言える。

以上の理由から、私はモデル3を採択するべきであると考える。
